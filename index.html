<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap');

:root {
  --bg: #f5f0e8;
  --surface: #fefcf7;
  --surface2: #f0ebe0;
  --border: #d6ceba;
  --ink: #1a1612;
  --ink2: #6b6154;
  --ink3: #a09483;
  --food: #e8623a;
  --expense: #3a8fe8;
  --sport: #3abf72;
  --sleep: #9b6fe8;
  --habit: #e8b83a;
  --accent: #c84b2f;
  --r: 6px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'DM Mono', monospace;
  min-height: 100vh;
  font-size: 13px;
}

/* Paper texture */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: 
    repeating-linear-gradient(0deg, transparent, transparent 27px, rgba(180,160,120,0.07) 28px);
  pointer-events: none;
  z-index: 0;
}

/* LAYOUT */
.app { position: relative; z-index: 1; max-width: 1100px; margin: 0 auto; padding: 0 1rem 4rem; }

/* HEADER */
header {
  padding: 2rem 0 1.5rem;
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
  border-bottom: 2px solid var(--ink);
  margin-bottom: 2rem;
}

.header-left h1 {
  font-family: 'DM Serif Display', serif;
  font-size: clamp(2rem, 5vw, 3rem);
  line-height: 1;
  letter-spacing: -0.02em;
}

.header-left h1 em {
  font-style: italic;
  color: var(--accent);
}

.date-display {
  font-size: 0.7rem;
  color: var(--ink3);
  letter-spacing: 0.12em;
  text-transform: uppercase;
  margin-top: 0.4rem;
}

.date-nav {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.date-nav button {
  background: var(--ink);
  color: var(--bg);
  border: none;
  width: 28px; height: 28px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.15s;
}
.date-nav button:hover { background: var(--accent); }
.date-nav .current-date {
  font-size: 0.75rem;
  letter-spacing: 0.05em;
  min-width: 100px;
  text-align: center;
  font-weight: 500;
}

/* TABS */
.tabs {
  display: flex;
  gap: 0;
  margin-bottom: 2rem;
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
}

.tab {
  padding: 0.6rem 1.2rem;
  cursor: pointer;
  font-family: 'DM Mono', monospace;
  font-size: 0.7rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  border: none;
  background: none;
  color: var(--ink3);
  border-bottom: 2px solid transparent;
  margin-bottom: -1px;
  transition: all 0.15s;
  white-space: nowrap;
}
.tab:hover { color: var(--ink); }
.tab.active { color: var(--ink); border-bottom-color: var(--ink); font-weight: 500; }

/* PANELS */
.panel { display: none; }
.panel.active { display: block; }

/* DASHBOARD GRID */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.2rem;
  margin-bottom: 2rem;
}

.summary-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 1.2rem;
  position: relative;
  overflow: hidden;
  animation: rise 0.4s ease both;
}

@keyframes rise {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}

.summary-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}
.summary-card.food::before   { background: var(--food); }
.summary-card.expense::before{ background: var(--expense); }
.summary-card.sport::before  { background: var(--sport); }
.summary-card.sleep::before  { background: var(--sleep); }
.summary-card.habit::before  { background: var(--habit); }

.card-label {
  font-size: 0.6rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--ink3);
  margin-bottom: 0.4rem;
}

.card-value {
  font-family: 'DM Serif Display', serif;
  font-size: 2rem;
  line-height: 1;
  margin-bottom: 0.2rem;
}

.card-sub {
  font-size: 0.65rem;
  color: var(--ink3);
}

/* SECTION PANELS */
.section-layout {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
}
@media (max-width: 650px) { .section-layout { grid-template-columns: 1fr; } }

.section-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 1.4rem;
}

.section-box h3 {
  font-family: 'DM Serif Display', serif;
  font-size: 1.1rem;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.section-box h3 .dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* FORM ELEMENTS */
.form-row {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.6rem;
  flex-wrap: wrap;
}

.form-row input, .form-row select {
  flex: 1;
  min-width: 80px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.45rem 0.7rem;
  font-family: 'DM Mono', monospace;
  font-size: 0.75rem;
  color: var(--ink);
  outline: none;
  transition: border-color 0.15s;
}
.form-row input:focus, .form-row select:focus { border-color: var(--ink); }
.form-row input::placeholder { color: var(--ink3); }

.btn-add {
  background: var(--ink);
  color: var(--bg);
  border: none;
  border-radius: 4px;
  padding: 0.45rem 1rem;
  font-family: 'DM Mono', monospace;
  font-size: 0.72rem;
  letter-spacing: 0.05em;
  cursor: pointer;
  transition: background 0.15s;
  white-space: nowrap;
}
.btn-add:hover { background: var(--accent); }

/* LOG LIST */
.log-list {
  margin-top: 0.8rem;
  max-height: 220px;
  overflow-y: auto;
}

.log-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.45rem 0;
  border-bottom: 1px dashed var(--border);
  gap: 0.5rem;
  animation: rise 0.25s ease both;
}

.log-item:last-child { border-bottom: none; }

.log-name {
  flex: 1;
  font-size: 0.75rem;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.log-val {
  font-size: 0.72rem;
  color: var(--ink2);
  white-space: nowrap;
}

.log-del {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--ink3);
  font-size: 0.8rem;
  padding: 0 0.2rem;
  line-height: 1;
  transition: color 0.15s;
}
.log-del:hover { color: var(--accent); }

.empty-state {
  text-align: center;
  padding: 1.5rem;
  color: var(--ink3);
  font-size: 0.72rem;
  letter-spacing: 0.05em;
}

/* CHART AREA */
.chart-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 1.4rem;
  margin-bottom: 1.2rem;
}

.chart-box h3 {
  font-family: 'DM Serif Display', serif;
  font-size: 1.1rem;
  margin-bottom: 1rem;
}

.chart-wrap { position: relative; height: 200px; }

/* SLEEP SECTION */
.sleep-visual {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.sleep-arc {
  width: 80px; height: 80px;
  flex-shrink: 0;
}

.sleep-info .big { font-family: 'DM Serif Display', serif; font-size: 2rem; }
.sleep-info .sub { font-size: 0.65rem; color: var(--ink3); }

/* HABITS */
.habit-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.5rem;
  margin-top: 0.8rem;
}

.habit-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  background: var(--surface2);
  border-radius: 4px;
  cursor: pointer;
  border: 1px solid var(--border);
  transition: all 0.15s;
  user-select: none;
}

.habit-item.done {
  background: #eef8f2;
  border-color: var(--sport);
}

.habit-check {
  width: 18px; height: 18px;
  border: 1.5px solid var(--border);
  border-radius: 3px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  font-size: 0.7rem;
  transition: all 0.15s;
}
.habit-item.done .habit-check { background: var(--sport); border-color: var(--sport); color: white; }

.habit-name { font-size: 0.72rem; flex: 1; }

/* WEEKLY CHARTS PANEL */
.weekly-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.2rem;
}
@media (max-width: 650px) { .weekly-grid { grid-template-columns: 1fr; } }

/* SCROLLBAR */
.log-list::-webkit-scrollbar { width: 4px; }
.log-list::-webkit-scrollbar-track { background: var(--surface2); }
.log-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* RANGE SLIDER */
input[type=range] {
  -webkit-appearance: none;
  width: 100%;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  outline: none;
  margin: 0.5rem 0;
}
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px; height: 16px;
  background: var(--ink);
  border-radius: 50%;
  cursor: pointer;
}

.range-labels { display: flex; justify-content: space-between; font-size: 0.6rem; color: var(--ink3); }

/* NOTES */
textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.7rem;
  font-family: 'DM Mono', monospace;
  font-size: 0.75rem;
  color: var(--ink);
  resize: vertical;
  min-height: 100px;
  outline: none;
  line-height: 1.6;
}
textarea:focus { border-color: var(--ink); }

.save-btn {
  margin-top: 0.6rem;
  background: var(--ink);
  color: var(--bg);
  border: none;
  border-radius: 4px;
  padding: 0.5rem 1.2rem;
  font-family: 'DM Mono', monospace;
  font-size: 0.72rem;
  cursor: pointer;
  transition: background 0.15s;
}
.save-btn:hover { background: var(--accent); }

.saved-note {
  font-size: 0.72rem;
  color: var(--ink2);
  line-height: 1.6;
  white-space: pre-wrap;
  padding: 0.7rem;
  background: var(--surface2);
  border-radius: 4px;
  border: 1px dashed var(--border);
}

.streak-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 0.65rem;
  background: #fff8e0;
  border: 1px solid var(--habit);
  border-radius: 20px;
  padding: 2px 8px;
  color: #b8860b;
  margin-left: auto;
}

/* FOOD 3-COL */
.food-three-col {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 1.2rem;
}
@media (max-width: 900px) { .food-three-col { grid-template-columns: 1fr 1fr; } }
@media (max-width: 580px) { .food-three-col { grid-template-columns: 1fr; } }

/* FOOD LIBRARY ITEMS */
.lib-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.55rem 0.6rem;
  border-radius: 4px;
  border: 1px solid var(--border);
  margin-bottom: 0.4rem;
  cursor: pointer;
  transition: all 0.15s;
  background: var(--surface2);
  animation: rise 0.2s ease both;
}
.lib-item:hover { border-color: var(--food); background: #fff5f2; }
.lib-item-name { font-size: 0.75rem; font-weight: 500; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.lib-item-meta { font-size: 0.62rem; color: var(--ink3); white-space: nowrap; }
.lib-del { background: none; border: none; cursor: pointer; color: var(--ink3); font-size: 0.75rem; padding: 0 0.2rem; transition: color 0.15s; flex-shrink:0; }
.lib-del:hover { color: var(--accent); }

/* DROPDOWN ITEMS */
.drop-item {
  padding: 0.5rem 0.8rem;
  cursor: pointer;
  font-size: 0.75rem;
  border-bottom: 1px solid var(--surface2);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.1s;
}
.drop-item:last-child { border-bottom: none; }
.drop-item:hover { background: var(--surface2); }
.drop-item-meta { font-size: 0.62rem; color: var(--ink3); }

/* TODO LAYOUT */
.todo-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; }
@media (max-width: 650px) { .todo-layout { grid-template-columns: 1fr; } }

.todo-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 3px solid var(--border);
  border-radius: var(--r);
  padding: 0.8rem 0.9rem;
  margin-bottom: 0.5rem;
  animation: rise 0.2s ease both;
  transition: opacity 0.2s;
}
.todo-item.done-item { opacity: 0.45; }
.todo-item.done-item .todo-title { text-decoration: line-through; color: var(--ink3); }
.todo-item[data-priority="high"]    { border-left-color: var(--food); }
.todo-item[data-priority="medium"]  { border-left-color: var(--habit); }
.todo-item[data-priority="low"]     { border-left-color: var(--sport); }

.todo-top { display: flex; align-items: flex-start; gap: 0.6rem; }
.todo-check {
  width: 18px; height: 18px; flex-shrink: 0; margin-top: 1px;
  border: 1.5px solid var(--border); border-radius: 3px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; transition: all 0.15s; background: var(--surface2);
}
.todo-item.done-item .todo-check { background: var(--sport); border-color: var(--sport); color: white; }
.todo-title { flex: 1; font-size: 0.8rem; font-weight: 500; line-height: 1.4; cursor: pointer; }
.todo-actions { display: flex; gap: 4px; margin-left: auto; flex-shrink: 0; }
.todo-btn { background: none; border: none; cursor: pointer; color: var(--ink3); font-size: 0.75rem; padding: 2px 4px; transition: color 0.15s; }
.todo-btn:hover { color: var(--accent); }

.todo-meta { display: flex; gap: 0.5rem; margin-top: 0.4rem; margin-left: 1.6rem; flex-wrap: wrap; align-items: center; }
.todo-tag { font-size: 0.58rem; letter-spacing: 0.08em; text-transform: uppercase; padding: 2px 6px; border-radius: 10px; background: var(--surface2); border: 1px solid var(--border); color: var(--ink3); }
.todo-due { font-size: 0.62rem; color: var(--ink3); }
.todo-due.overdue { color: var(--food); font-weight: 500; }

.todo-subtasks { margin-top: 0.5rem; margin-left: 1.6rem; }
.subtask-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0; font-size: 0.72rem; color: var(--ink2); }
.subtask-check { width: 14px; height: 14px; flex-shrink: 0; border: 1.5px solid var(--border); border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; transition: all 0.15s; }
.subtask-item.sub-done .subtask-check { background: var(--sport); border-color: var(--sport); color: white; }
.subtask-item.sub-done span { text-decoration: line-through; color: var(--ink3); }
.subtask-add { display: flex; gap: 0.4rem; margin-top: 0.3rem; }
.subtask-add input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 3px; padding: 0.3rem 0.5rem; font-family: 'DM Mono', monospace; font-size: 0.68rem; color: var(--ink); outline: none; }
.subtask-add button { background: var(--ink); color: var(--bg); border: none; border-radius: 3px; padding: 0.3rem 0.6rem; font-family: 'DM Mono', monospace; font-size: 0.65rem; cursor: pointer; }

.priority-badge { font-size: 0.58rem; letter-spacing: 0.08em; text-transform: uppercase; padding: 2px 6px; border-radius: 10px; font-weight: 700; }
.priority-badge.high   { background: rgba(232,98,58,0.12);  color: var(--food); }
.priority-badge.medium { background: rgba(232,184,58,0.12); color: #b8860b; }
.priority-badge.low    { background: rgba(58,191,114,0.12); color: #1e8a4c; }

.todo-section-title {
  font-size: 0.62rem; letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--ink3); margin: 1rem 0 0.5rem; display: flex; align-items: center; gap: 0.5rem;
}
.todo-section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

.filter-bar { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 1rem; }
.filter-btn { font-family: 'DM Mono', monospace; font-size: 0.62rem; letter-spacing: 0.06em; text-transform: uppercase; background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 3px 10px; cursor: pointer; transition: all 0.15s; color: var(--ink2); }
.filter-btn.active { background: var(--ink); color: var(--bg); border-color: var(--ink); }

.todo-stats { display: flex; gap: 1.2rem; margin-bottom: 1.2rem; flex-wrap: wrap; }
.todo-stat { text-align: center; }
.todo-stat .num { font-family: 'DM Serif Display', serif; font-size: 1.6rem; line-height: 1; }
.todo-stat .lbl { font-size: 0.6rem; color: var(--ink3); letter-spacing: 0.08em; text-transform: uppercase; }

/* WELLNESS PAGE */
.wellness-section-label {
  font-size: 0.65rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--ink3);
  font-weight: 500;
  margin-bottom: 0.8rem;
  display: flex;
  align-items: center;
  gap: 0.6rem;
}
.wellness-section-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}
.wellness-divider {
  border: none;
  border-top: 2px dashed var(--border);
  margin: 1.8rem 0;
}

/* SUB-TABS */
.sub-tabs {
  display: flex;
  gap: 0;
  margin-bottom: 1.4rem;
  border-bottom: 2px solid var(--border);
}
.sub-tab {
  padding: 0.5rem 1.2rem;
  cursor: pointer;
  font-family: 'DM Mono', monospace;
  font-size: 0.72rem;
  letter-spacing: 0.08em;
  border: none;
  background: none;
  color: var(--ink3);
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.15s;
  white-space: nowrap;
}
.sub-tab:hover { color: var(--ink); }
.sub-tab.active { color: var(--food); border-bottom-color: var(--food); font-weight: 500; }

/* ‚îÄ‚îÄ MEAL PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.meal-topbar {
  display: flex; align-items: center; gap: 0.8rem;
  margin-bottom: 1rem; flex-wrap: wrap;
}
.meal-search {
  flex: 1; min-width: 160px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 4px; padding: 0.45rem 0.7rem;
  font-family: 'DM Mono', monospace; font-size: 0.75rem; color: var(--ink); outline: none;
}
.meal-view-toggle { display: flex; gap: 0; }
.view-btn {
  background: var(--surface2); border: 1px solid var(--border);
  font-size: 1rem; padding: 0.3rem 0.6rem; cursor: pointer;
  color: var(--ink3); transition: all 0.15s;
}
.view-btn:first-child { border-radius: 4px 0 0 4px; }
.view-btn:last-child  { border-radius: 0 4px 4px 0; border-left: none; }
.view-btn.active { background: var(--ink); color: var(--bg); border-color: var(--ink); }

/* Category pills */
.meal-cats { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 1rem; }
.meal-cat-pill {
  font-size: 0.65rem; letter-spacing: 0.08em; text-transform: uppercase;
  padding: 3px 10px; border-radius: 20px; cursor: pointer;
  border: 1px solid var(--border); background: var(--surface2); color: var(--ink3);
  transition: all 0.15s;
}
.meal-cat-pill.active { background: var(--food); color: white; border-color: var(--food); }

/* GRID VIEW */
.meal-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}
.meal-grid-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.2s;
  animation: rise 0.25s ease both;
  position: relative;
}
.meal-grid-card:hover { border-color: var(--food); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.07); }
.meal-grid-card-color {
  height: 6px;
  background: var(--food);
}
.meal-grid-card-body { padding: 0.9rem; }
.meal-grid-card-name {
  font-family: 'DM Serif Display', serif;
  font-size: 1rem; line-height: 1.2;
  margin-bottom: 0.3rem;
}
.meal-grid-card-cat { font-size: 0.62rem; color: var(--ink3); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.6rem; }
.meal-grid-macros { display: flex; gap: 0.35rem; flex-wrap: wrap; }
.meal-macro-badge {
  font-size: 0.58rem; padding: 2px 6px; border-radius: 8px;
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--ink2);
}
.meal-grid-card-actions {
  display: flex; gap: 4px; padding: 0 0.9rem 0.8rem;
  justify-content: flex-end;
}
.meal-grid-card-actions button {
  background: none; border: 1px solid var(--border); border-radius: 4px;
  padding: 3px 8px; font-size: 0.65rem; cursor: pointer;
  font-family: 'DM Mono', monospace; color: var(--ink2);
  transition: all 0.15s;
}
.meal-grid-card-actions button:hover { background: var(--food); color: white; border-color: var(--food); }
.meal-grid-card-actions .log-btn { background: var(--food); color: white; border-color: var(--food); }
.meal-grid-card-actions .log-btn:hover { opacity: 0.85; }

/* LIST VIEW */
.meal-list-table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
.meal-list-table th {
  font-size: 0.6rem; letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--ink3); text-align: left; padding: 0.5rem 0.8rem;
  border-bottom: 2px solid var(--border); font-weight: 500;
}
.meal-list-row {
  border-bottom: 1px solid var(--border);
  animation: rise 0.2s ease both;
  transition: background 0.15s;
}
.meal-list-row:hover { background: var(--surface2); }
.meal-list-row td { padding: 0.7rem 0.8rem; font-size: 0.75rem; vertical-align: middle; }
.meal-list-row .ml-name { font-weight: 500; }
.meal-list-row .ml-cat { font-size: 0.65rem; color: var(--ink3); }
.meal-list-actions { display: flex; gap: 4px; }
.meal-list-actions button {
  background: none; border: 1px solid var(--border); border-radius: 3px;
  padding: 2px 7px; font-size: 0.62rem; cursor: pointer;
  font-family: 'DM Mono', monospace; color: var(--ink2); transition: all 0.15s;
}
.meal-list-actions button:hover { background: var(--food); color: white; border-color: var(--food); }
.meal-list-actions .log-btn { background: var(--food); color: white; border-color: var(--food); }

/* MEAL PLANNER */
.meal-planner-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 1.2rem;
  margin-top: 0.5rem;
}
.meal-planner-title {
  font-family: 'DM Serif Display', serif;
  font-size: 1rem; margin-bottom: 0.9rem;
}
.meal-planner-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.5rem;
}
@media (max-width: 700px) { .meal-planner-grid { grid-template-columns: repeat(4, 1fr); } }
.planner-day {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 5px;
  padding: 0.5rem;
  min-height: 90px;
}
.planner-day.today { border-color: var(--food); background: #fff5f2; }
.planner-day-label { font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--ink3); margin-bottom: 0.4rem; }
.planner-day-date  { font-family: 'DM Serif Display', serif; font-size: 1.1rem; margin-bottom: 0.4rem; }
.planner-meal-chip {
  font-size: 0.6rem; padding: 2px 6px; border-radius: 3px;
  background: var(--food); color: white;
  margin-bottom: 2px; cursor: pointer;
  display: flex; align-items: center; gap: 3px;
  animation: rise 0.15s ease both;
}
.planner-meal-chip .chip-del { font-size: 0.55rem; opacity: 0.7; margin-left: auto; }
.planner-add-btn {
  background: none; border: 1px dashed var(--border); border-radius: 3px;
  width: 100%; padding: 2px; font-size: 0.65rem; color: var(--ink3);
  cursor: pointer; transition: all 0.15s; margin-top: 2px;
  font-family: 'DM Mono', monospace;
}
.planner-add-btn:hover { border-color: var(--food); color: var(--food); }
.planner-select {
  width: 100%; margin-top: 4px;
  background: var(--surface); border: 1px solid var(--food);
  border-radius: 3px; font-size: 0.62rem; padding: 3px;
  font-family: 'DM Mono', monospace; color: var(--ink); outline: none;
}

/* MODAL */
.meal-modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(10,10,15,0.55); z-index: 200;
  align-items: center; justify-content: center;
}
.meal-modal-overlay.open { display: flex; }
.meal-modal {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; width: min(820px, 95vw);
  max-height: 90vh; overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  animation: rise 0.25s ease both;
}
.meal-modal-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 1.2rem 1.4rem; border-bottom: 1px solid var(--border);
}
.meal-modal-body {
  display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;
  padding: 1.2rem 1.4rem;
}
@media (max-width: 580px) { .meal-modal-body { grid-template-columns: 1fr; } }
.meal-modal-col {}

/* INGREDIENT & STEP BUILDER */
.ing-item-build, .step-item-build {
  display: flex; align-items: center; gap: 0.5rem;
  padding: 0.3rem 0.5rem; background: var(--surface2);
  border-radius: 4px; margin-bottom: 0.3rem;
  font-size: 0.72rem; animation: rise 0.15s ease both;
}
.ing-item-build span, .step-item-build span { flex: 1; }
.ing-del, .step-del {
  background: none; border: none; cursor: pointer;
  color: var(--ink3); font-size: 0.7rem; transition: color 0.15s;
}
.ing-del:hover, .step-del:hover { color: var(--accent); }

/* expanded detail in list view */
.recipe-detail { display: none; padding: 0.6rem 0.8rem; background: var(--surface2); border-top: 1px dashed var(--border); }
.recipe-detail.open { display: block; }
.recipe-detail-section { font-size: 0.6rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--ink3); margin: 0.5rem 0 0.2rem; }
.recipe-ing-item, .recipe-step-item { font-size: 0.72rem; color: var(--ink2); padding: 0.15rem 0; display: flex; gap: 0.5rem; }
.recipe-step-num { font-size: 0.58rem; background: var(--food); color: white; border-radius: 50%; width:15px; height:15px; display:flex; align-items:center; justify-content:center; flex-shrink:0; margin-top:2px; }

/* ‚îÄ‚îÄ RECIPE BOOK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.rb-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 1.1rem;
  margin-bottom: 2rem;
}
.rb-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.2s;
  animation: rise 0.25s ease both;
}
.rb-card:hover { border-color: var(--food); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
.rb-card-header {
  background: var(--food);
  padding: 1rem 1rem 0.7rem;
  position: relative;
}
.rb-card-name {
  font-family: 'DM Serif Display', serif;
  font-size: 1.05rem;
  color: white;
  line-height: 1.2;
  margin-bottom: 0.2rem;
}
.rb-card-sub { font-size: 0.62rem; color: rgba(255,255,255,0.75); letter-spacing: 0.06em; }
.rb-card-body { padding: 0.8rem 1rem; }
.rb-card-times {
  display: flex; gap: 0.8rem; margin-bottom: 0.6rem;
  font-size: 0.62rem; color: var(--ink3);
}
.rb-nutrition-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.3rem;
  margin-bottom: 0.7rem;
}
.rb-nut-cell {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.3rem 0.4rem;
  text-align: center;
}
.rb-nut-val { font-family: 'DM Serif Display', serif; font-size: 0.95rem; line-height: 1; }
.rb-nut-lbl { font-size: 0.52rem; color: var(--ink3); text-transform: uppercase; letter-spacing: 0.06em; margin-top: 1px; }
.rb-card-footer {
  padding: 0.6rem 1rem;
  border-top: 1px solid var(--border);
  display: flex; gap: 0.4rem; justify-content: flex-end;
}
.rb-card-footer button {
  background: none; border: 1px solid var(--border); border-radius: 4px;
  padding: 3px 9px; font-size: 0.65rem; cursor: pointer;
  font-family: 'DM Mono', monospace; color: var(--ink2); transition: all 0.15s;
}
.rb-card-footer button:hover { background: var(--food); color: white; border-color: var(--food); }
.rb-card-footer .rb-view-btn { background: var(--food); color: white; border-color: var(--food); }
.rb-card-footer .rb-view-btn:hover { opacity: 0.85; }

/* RECIPE DETAIL MODAL */
.rb-detail-header {
  padding: 1.5rem 1.6rem 1rem;
  background: var(--food);
  color: white;
  position: relative;
}
.rb-detail-header h2 { font-family: 'DM Serif Display', serif; font-size: 1.6rem; line-height: 1.1; margin-bottom: 0.3rem; }
.rb-detail-header .rb-sub { font-size: 0.7rem; opacity: 0.8; letter-spacing: 0.06em; }
.rb-detail-close { position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; transition: background 0.15s; }
.rb-detail-close:hover { background: rgba(255,255,255,0.35); }
.rb-detail-body { padding: 1.2rem 1.6rem 1.6rem; }
.rb-detail-section-title {
  font-size: 0.6rem; letter-spacing: 0.14em; text-transform: uppercase;
  color: var(--ink3); margin: 1.2rem 0 0.5rem;
  display: flex; align-items: center; gap: 0.5rem;
}
.rb-detail-section-title::after { content:''; flex:1; height:1px; background: var(--border); }
.rb-nut-full {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(90px,1fr));
  gap: 0.5rem; margin-bottom: 0.5rem;
}
.rb-nut-full-cell {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 5px; padding: 0.5rem; text-align: center;
}
.rb-nut-full-cell .val { font-family: 'DM Serif Display', serif; font-size: 1.2rem; line-height: 1; }
.rb-nut-full-cell .lbl { font-size: 0.55rem; color: var(--ink3); text-transform: uppercase; letter-spacing: 0.06em; margin-top: 2px; }
.rb-ing-table { width: 100%; border-collapse: collapse; }
.rb-ing-table td { padding: 0.35rem 0.5rem; font-size: 0.75rem; border-bottom: 1px solid var(--surface2); }
.rb-ing-table tr:last-child td { border-bottom: none; }
.rb-ing-table td:first-child { color: var(--ink3); font-size: 0.65rem; width: 30%; }
.rb-step-item-view { display: flex; gap: 0.8rem; margin-bottom: 0.8rem; align-items: flex-start; }
.rb-step-num-view {
  background: var(--food); color: white; border-radius: 50%;
  min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; font-weight: 700; flex-shrink: 0; margin-top: 1px;
}
.rb-step-text-view { font-size: 0.78rem; line-height: 1.7; color: var(--ink2); }
.rb-notes-box { background: var(--surface2); border-left: 3px solid var(--food); padding: 0.7rem 1rem; border-radius: 0 4px 4px 0; font-size: 0.75rem; color: var(--ink2); line-height: 1.7; }
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen" style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);position:relative;z-index:10;">
  <div style="text-align:center;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:3rem 2.5rem;max-width:380px;width:90%;box-shadow:0 8px 40px rgba(0,0,0,0.08);">
    <h1 style="font-family:'DM Serif Display',serif;font-size:2.2rem;line-height:1;margin-bottom:0.3rem;">Daily <em style="font-style:italic;color:var(--accent)">Tracker</em></h1>
    <p style="font-size:0.72rem;color:var(--ink3);letter-spacing:0.08em;text-transform:uppercase;margin-bottom:2rem;">your personal log</p>
    <button id="signin-btn" onclick="googleSignIn()"
      style="display:inline-flex;align-items:center;gap:0.7rem;background:var(--ink);color:var(--bg);border:none;border-radius:6px;padding:0.75rem 1.5rem;font-family:'DM Mono',monospace;font-size:0.8rem;letter-spacing:0.05em;cursor:pointer;transition:background 0.15s;width:100%;justify-content:center;">
      <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20H24v8h11.3C33.6 32.6 29.2 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.8 1.1 7.9 3l5.7-5.7C34.1 6.5 29.3 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 19.6-8 19.6-20 0-1.3-.1-2.7-.4-4z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.6 15.1 19 12 24 12c3 0 5.8 1.1 7.9 3l5.7-5.7C34.1 6.5 29.3 4 24 4 16.3 4 9.7 8.3 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 9.9-1.9 13.5-5.1l-6.2-5.2C29.4 35.5 26.8 36 24 36c-5.2 0-9.6-3.4-11.3-8.1l-6.6 5.1C9.7 39.7 16.3 44 24 44z"/><path fill="#1976D2" d="M43.6 20H24v8h11.3c-.9 2.4-2.5 4.4-4.7 5.7l6.2 5.2C40.8 35.6 44 30.2 44 24c0-1.3-.1-2.7-.4-4z"/></svg>
      Sign in with Google
    </button>
    <p style="font-size:0.62rem;color:var(--ink3);margin-top:1.2rem;line-height:1.6;">Your data is private and synced<br>securely to your Google account.</p>
  </div>
</div>

<!-- MAIN APP (hidden until signed in) -->
<div id="app-wrapper" style="display:none;">
<div class="app">

  <header>
    <div class="header-left">
      <h1>Daily <em>Tracker</em></h1>
      <div class="date-display">your personal log</div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:0.4rem">
      <div id="sync-indicator" style="font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;color:#3abf72;opacity:0;transition:opacity 0.4s;min-height:1em">‚úì saved</div>
      <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:0.3rem;justify-content:flex-end;">
        <img id="user-avatar" src="" alt="" style="display:none;width:24px;height:24px;border-radius:50%;object-fit:cover;border:1.5px solid var(--border);" />
        <span id="user-name" style="font-size:0.62rem;color:var(--ink3);letter-spacing:0.06em;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
        <button onclick="googleSignOut()" style="background:none;border:1px solid var(--border);border-radius:4px;padding:2px 8px;font-family:'DM Mono',monospace;font-size:0.58rem;color:var(--ink3);cursor:pointer;transition:all 0.15s;letter-spacing:0.06em;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--ink3)'">sign out</button>
      </div>
      <div class="date-nav">
        <button onclick="changeDay(-1)">‚Äπ</button>
        <div class="current-date" id="currentDateDisplay"></div>
        <button onclick="changeDay(1)">‚Ä∫</button>
      </div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="tab" onclick="switchTab('todo')">‚òë To-Do</button>
    <button class="tab" onclick="switchTab('food')">üçΩ Food</button>
    <button class="tab" onclick="switchTab('expenses')">üí∏ Expenses</button>
    <button class="tab" onclick="switchTab('wellness')">üèÉ Wellness</button>
    <button class="tab" onclick="switchTab('notes')">üìù Notes</button>
    <button class="tab" onclick="switchTab('weekly')">üìä Weekly</button>
  </div>

  <!-- DASHBOARD -->
  <div class="panel active" id="panel-dashboard">
    <div class="dashboard-grid">
      <div class="summary-card food">
        <div class="card-label">Calories Today</div>
        <div class="card-value" id="dash-cal">0</div>
        <div class="card-sub" id="dash-cal-sub">no entries yet</div>
      </div>
      <div class="summary-card expense">
        <div class="card-label">Spent Today</div>
        <div class="card-value" id="dash-exp">Rp 0</div>
        <div class="card-sub" id="dash-exp-sub">no entries yet</div>
      </div>
      <div class="summary-card sport">
        <div class="card-label">Exercise</div>
        <div class="card-value" id="dash-sport">0 min</div>
        <div class="card-sub" id="dash-sport-sub">no entries yet</div>
      </div>
      <div class="summary-card sleep">
        <div class="card-label">Sleep Last Night</div>
        <div class="card-value" id="dash-sleep">‚Äî</div>
        <div class="card-sub" id="dash-sleep-sub">not logged</div>
      </div>
      <div class="summary-card habit">
        <div class="card-label">Habits Done</div>
        <div class="card-value" id="dash-habits">0/0</div>
        <div class="card-sub" id="dash-habits-sub">set up your habits</div>
      </div>
    </div>
    <div class="chart-box">
      <h3>Today at a Glance</h3>
      <div class="chart-wrap"><canvas id="chartDash"></canvas></div>
    </div>
  </div>

  <!-- FOOD -->
  <div class="panel" id="panel-food">

    <!-- Food sub-tabs -->
    <div class="sub-tabs">
      <button class="sub-tab active" id="stab-log" onclick="switchFoodTab('log',this)">üçΩ Food Log</button>
      <button class="sub-tab" id="stab-recipe" onclick="switchFoodTab('recipe',this)">üç≤ Meals</button>
      <button class="sub-tab" id="stab-recipebook" onclick="switchFoodTab('recipebook',this)">üìñ Recipes</button>
    </div>

    <!-- SUB: Food Log -->
    <div id="sfood-log">
      <div class="food-three-col">
        <!-- LEFT: Log form -->
        <div class="section-box">
          <h3><span class="dot" style="background:var(--food)"></span>Log a Meal</h3>
          <div style="position:relative;margin-bottom:0.8rem">
            <input type="text" id="food-search" placeholder="üîç Search saved foods‚Ä¶" oninput="filterLibrary()" autocomplete="off"
              style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:0.45rem 0.7rem;font-family:'DM Mono',monospace;font-size:0.75rem;color:var(--ink);outline:none;" />
            <div id="food-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-top:none;border-radius:0 0 4px 4px;max-height:160px;overflow-y:auto;z-index:50;box-shadow:0 4px 12px rgba(0,0,0,0.1)"></div>
          </div>
          <div class="form-row">
            <input type="text" id="food-name" placeholder="Food item" />
          </div>
          <div class="form-row">
            <input type="number" id="food-cal" placeholder="Calories" min="0" />
            <input type="text" id="food-meal" placeholder="Meal (breakfast‚Ä¶)" />
          </div>
          <div class="form-row">
            <input type="number" id="food-protein" placeholder="Protein (g)" min="0" />
            <input type="number" id="food-carbs" placeholder="Carbs (g)" min="0" />
            <input type="number" id="food-fat" placeholder="Fat (g)" min="0" />
          </div>
          <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.5rem">
            <button class="btn-add" onclick="addFood()">+ Log</button>
            <button class="btn-add" onclick="saveToLibrary()" style="background:var(--food)">&#128190; Save to Library</button>
          </div>
          <div class="log-list" id="food-list"></div>
        </div>
        <!-- MIDDLE: Nutrition chart -->
        <div class="section-box">
          <h3>Nutrition Breakdown</h3>
          <div class="chart-wrap"><canvas id="chartFood"></canvas></div>
          <div style="margin-top:1rem">
            <div class="card-label">Daily Totals</div>
            <div style="display:flex; gap:1.5rem; margin-top:0.4rem; flex-wrap:wrap">
              <div><div class="card-label">Calories</div><div id="total-cal" style="font-family:'DM Serif Display',serif;font-size:1.4rem">0</div></div>
              <div><div class="card-label">Protein</div><div id="total-protein" style="font-family:'DM Serif Display',serif;font-size:1.4rem">0g</div></div>
              <div><div class="card-label">Carbs</div><div id="total-carbs" style="font-family:'DM Serif Display',serif;font-size:1.4rem">0g</div></div>
              <div><div class="card-label">Fat</div><div id="total-fat" style="font-family:'DM Serif Display',serif;font-size:1.4rem">0g</div></div>
            </div>
          </div>
        </div>
        <!-- RIGHT: Food library -->
        <div class="section-box">
          <h3>üìö Food Library</h3>
          <div style="font-size:0.65rem;color:var(--ink3);margin-bottom:0.8rem;line-height:1.5">Saved foods ‚Äî tap to auto-fill the form, or use the search above</div>
          <div id="library-list" style="max-height:400px;overflow-y:auto"></div>
        </div>
      </div>
    </div>

    <!-- SUB: Recipes -->
    <div id="sfood-recipe" style="display:none">

      <!-- Top bar: search + view toggle + add button -->
      <div class="meal-topbar">
        <input type="text" id="recipe-search" placeholder="üîç Search meals‚Ä¶" oninput="renderRecipeList()"
          class="meal-search" />
        <div class="meal-view-toggle">
          <button class="view-btn active" id="vbtn-grid" onclick="setMealView('grid',this)" title="Grid view">‚äû</button>
          <button class="view-btn" id="vbtn-list" onclick="setMealView('list',this)" title="List view">‚ò∞</button>
        </div>
        <button class="btn-add" onclick="openMealForm(null)" style="white-space:nowrap">+ New Meal</button>
      </div>

      <!-- Category filter pills -->
      <div class="meal-cats" id="meal-cats"></div>

      <!-- Card grid / list -->
      <div id="recipe-list"></div>

      <!-- Meal planner strip -->
      <div class="meal-planner-wrap">
        <div class="meal-planner-title">üìÖ Meal Planner ‚Äî this week</div>
        <div class="meal-planner-grid" id="meal-planner-grid"></div>
      </div>

      <!-- ADD / EDIT MODAL overlay -->
      <div id="meal-modal-overlay" class="meal-modal-overlay" onclick="closeMealForm(event)">
        <div class="meal-modal" onclick="event.stopPropagation()">
          <div class="meal-modal-header">
            <span id="recipe-form-title" style="font-family:'DM Serif Display',serif;font-size:1.2rem">New Meal</span>
            <button onclick="closeMealForm()" class="log-del" style="font-size:1rem">‚úï</button>
          </div>
          <input type="hidden" id="recipe-edit-id" value="" />

          <div class="meal-modal-body">
            <!-- Left col -->
            <div class="meal-modal-col">
              <div class="card-label" style="margin-bottom:0.4rem">Meal name</div>
              <div class="form-row"><input type="text" id="recipe-name" placeholder="e.g. Nasi Goreng" /></div>
              <div class="form-row">
                <input type="text" id="recipe-category" placeholder="Category (Breakfast, Dinner‚Ä¶)" />
                <input type="number" id="recipe-servings" placeholder="Servings" min="1" value="1" style="max-width:90px" />
              </div>

              <div class="card-label" style="margin:0.9rem 0 0.4rem">Nutrition <span style="font-weight:400;color:var(--ink3)">per serving</span></div>
              <div class="form-row">
                <input type="number" id="recipe-cal" placeholder="Calories" min="0" />
                <input type="number" id="recipe-protein" placeholder="Protein (g)" min="0" />
              </div>
              <div class="form-row">
                <input type="number" id="recipe-carbs" placeholder="Carbs (g)" min="0" />
                <input type="number" id="recipe-fat" placeholder="Fat (g)" min="0" />
              </div>
            </div>

            <!-- Right col -->
            <div class="meal-modal-col">
              <div class="card-label" style="margin-bottom:0.4rem">Ingredients</div>
              <div id="recipe-ingredients-list" style="margin-bottom:0.4rem;max-height:120px;overflow-y:auto"></div>
              <div class="form-row">
                <input type="text" id="ing-name" placeholder="Ingredient" />
                <input type="text" id="ing-qty" placeholder="Qty" style="max-width:80px"/>
                <button class="btn-add" onclick="addIngredient()" style="padding:0.45rem 0.7rem">+</button>
              </div>

              <div class="card-label" style="margin:0.9rem 0 0.4rem">Steps</div>
              <div id="recipe-steps-list" style="margin-bottom:0.4rem;max-height:120px;overflow-y:auto"></div>
              <div class="form-row">
                <input type="text" id="step-text" placeholder="Add a step‚Ä¶" onkeydown="if(event.key==='Enter')addStep()" />
                <button class="btn-add" onclick="addStep()" style="padding:0.45rem 0.7rem">+</button>
              </div>
            </div>
          </div>

          <div style="display:flex;gap:0.5rem;padding:1rem 1.4rem 1.2rem;border-top:1px solid var(--border);justify-content:flex-end">
            <button class="btn-add" onclick="clearRecipeForm()" style="background:var(--surface2);color:var(--ink2);border:1px solid var(--border)">‚úï Clear</button>
            <button class="btn-add" onclick="saveRecipe()" style="background:var(--food)">üíæ Save Meal</button>
          </div>
        </div>
      </div>

    </div>

    <!-- SUB: Recipe Book -->
    <div id="sfood-recipebook" style="display:none">

      <!-- Top bar -->
      <div class="meal-topbar">
        <input type="text" id="rb-search" placeholder="üîç Search recipes‚Ä¶" oninput="renderRecipeBook()"
          class="meal-search" />
        <select id="rb-filter-cat" onchange="renderRecipeBook()"
          style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:0.45rem 0.7rem;font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--ink);outline:none;">
          <option value="">All categories</option>
        </select>
        <button class="btn-add" onclick="openRecipeBookForm(null)" style="white-space:nowrap">+ New Recipe</button>
      </div>

      <!-- Recipe cards grid -->
      <div id="rb-list"></div>

      <!-- ADD / EDIT MODAL -->
      <div id="rb-modal-overlay" class="meal-modal-overlay" onclick="closeRecipeBookForm(event)">
        <div class="meal-modal" style="max-width:900px" onclick="event.stopPropagation()">
          <div class="meal-modal-header">
            <span id="rb-form-title" style="font-family:'DM Serif Display',serif;font-size:1.3rem">New Recipe</span>
            <button onclick="closeRecipeBookForm()" class="log-del" style="font-size:1rem">‚úï</button>
          </div>
          <input type="hidden" id="rb-edit-id" value="" />

          <!-- 3-col form body -->
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.2rem;padding:1.2rem 1.4rem">

            <!-- COL 1: Basic info + nutrition -->
            <div>
              <div class="card-label" style="margin-bottom:0.4rem">Recipe name *</div>
              <div class="form-row"><input type="text" id="rb-name" placeholder="e.g. Nasi Goreng Kampung" /></div>

              <div class="form-row" style="margin-top:0.3rem">
                <input type="text" id="rb-category" placeholder="Category (e.g. Breakfast)" />
                <input type="text" id="rb-cuisine" placeholder="Cuisine (e.g. Indonesian)" />
              </div>

              <div class="form-row">
                <input type="number" id="rb-servings" placeholder="Servings" min="1" value="1" />
                <input type="number" id="rb-preptime" placeholder="Prep (min)" min="0" />
                <input type="number" id="rb-cooktime" placeholder="Cook (min)" min="0" />
              </div>

              <div class="card-label" style="margin:0.9rem 0 0.5rem">Nutrition <span style="font-weight:400;color:var(--ink3)">per serving</span></div>
              <div class="form-row">
                <input type="number" id="rb-cal"     placeholder="Calories"   min="0" />
                <input type="number" id="rb-protein" placeholder="Protein (g)" min="0" />
              </div>
              <div class="form-row">
                <input type="number" id="rb-carbs"   placeholder="Carbs (g)"  min="0" />
                <input type="number" id="rb-fat"     placeholder="Fat (g)"    min="0" />
              </div>
              <div class="form-row">
                <input type="number" id="rb-fiber"   placeholder="Fiber (g)"  min="0" />
                <input type="number" id="rb-sugar"   placeholder="Sugar (g)"  min="0" />
                <input type="number" id="rb-sodium"  placeholder="Sodium (mg)" min="0" />
              </div>

              <div class="card-label" style="margin:0.9rem 0 0.4rem">Notes / Description</div>
              <textarea id="rb-notes" placeholder="Any notes about this recipe‚Ä¶"
                style="width:100%;min-height:80px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:0.5rem 0.7rem;font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--ink);resize:vertical;outline:none;line-height:1.6"></textarea>
            </div>

            <!-- COL 2: Ingredients -->
            <div>
              <div class="card-label" style="margin-bottom:0.5rem">Ingredients</div>
              <div id="rb-ing-list" style="max-height:340px;overflow-y:auto;margin-bottom:0.5rem"></div>
              <div class="form-row">
                <input type="text" id="rb-ing-name" placeholder="Ingredient" onkeydown="if(event.key==='Enter')addRbIng()" />
              </div>
              <div class="form-row">
                <input type="text" id="rb-ing-qty"  placeholder="Amount (e.g. 2 cups)" />
                <input type="text" id="rb-ing-note" placeholder="Note (optional)" />
                <button class="btn-add" onclick="addRbIng()" style="padding:0.45rem 0.7rem">+</button>
              </div>
            </div>

            <!-- COL 3: Steps -->
            <div>
              <div class="card-label" style="margin-bottom:0.5rem">Cooking Steps</div>
              <div id="rb-steps-list" style="max-height:340px;overflow-y:auto;margin-bottom:0.5rem"></div>
              <div class="form-row">
                <input type="text" id="rb-step-text" placeholder="Describe this step‚Ä¶" onkeydown="if(event.key==='Enter')addRbStep()" />
                <button class="btn-add" onclick="addRbStep()" style="padding:0.45rem 0.7rem">+</button>
              </div>
            </div>

          </div>

          <div style="display:flex;gap:0.5rem;padding:0.8rem 1.4rem 1.2rem;border-top:1px solid var(--border);justify-content:flex-end">
            <button class="btn-add" onclick="clearRbForm()" style="background:var(--surface2);color:var(--ink2);border:1px solid var(--border)">‚úï Clear</button>
            <button class="btn-add" onclick="saveRbRecipe()" style="background:var(--food)">üíæ Save Recipe</button>
          </div>
        </div>
      </div>

      <!-- DETAIL VIEW MODAL -->
      <div id="rb-detail-overlay" class="meal-modal-overlay" onclick="closeRbDetail(event)">
        <div id="rb-detail-modal" class="meal-modal" style="max-width:760px" onclick="event.stopPropagation()">
        </div>
      </div>

    </div>

  </div>

  <!-- EXPENSES -->
  <div class="panel" id="panel-expenses">
    <div class="section-layout">
      <div class="section-box">
        <h3><span class="dot" style="background:var(--expense)"></span>Log an Expense</h3>
        <div class="form-row">
          <input type="text" id="exp-desc" placeholder="Description" />
        </div>
        <div class="form-row">
          <input type="number" id="exp-amount" placeholder="Amount (Rp)" min="0" step="1" />
          <select id="exp-cat">
            <option>Food</option>
            <option>Transport</option>
            <option>Health</option>
            <option>Entertainment</option>
            <option>Shopping</option>
            <option>Bills</option>
            <option>Other</option>
          </select>
        </div>
        <button class="btn-add" onclick="addExpense()">+ Add</button>
        <div class="log-list" id="exp-list"></div>
      </div>
      <div class="section-box">
        <h3>Spending by Category</h3>
        <div class="chart-wrap"><canvas id="chartExp"></canvas></div>
        <div style="margin-top:1rem">
          <div class="card-label">Total Spent</div>
          <div id="total-exp" style="font-family:'DM Serif Display',serif;font-size:2rem;margin-top:0.3rem">Rp 0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- WELLNESS (Exercise + Sleep + Habits combined) -->
  <div class="panel" id="panel-wellness">

    <!-- Section label -->
    <div class="wellness-section-label">üèÉ Exercise</div>
    <div class="section-layout" style="margin-bottom:1.5rem">
      <div class="section-box">
        <h3><span class="dot" style="background:var(--sport)"></span>Log Exercise</h3>
        <div class="form-row">
          <input type="text" id="sport-name" placeholder="Activity (running, gym‚Ä¶)" />
        </div>
        <div class="form-row">
          <input type="number" id="sport-dur" placeholder="Duration (min)" min="0" />
          <input type="number" id="sport-cal" placeholder="Calories burned" min="0" />
        </div>
        <div class="form-row">
          <select id="sport-intensity">
            <option>Low</option>
            <option>Moderate</option>
            <option>High</option>
            <option>Max</option>
          </select>
          <input type="text" id="sport-notes" placeholder="Notes (optional)" />
        </div>
        <button class="btn-add" onclick="addSport()">+ Add</button>
        <div class="log-list" id="sport-list"></div>
      </div>
      <div class="section-box">
        <h3>Activity Summary</h3>
        <div class="chart-wrap"><canvas id="chartSport"></canvas></div>
        <div style="margin-top:1rem; display:flex; gap:1.5rem; flex-wrap:wrap">
          <div><div class="card-label">Total Time</div><div id="total-sport-time" style="font-family:'DM Serif Display',serif;font-size:1.4rem">0 min</div></div>
          <div><div class="card-label">Calories Burned</div><div id="total-sport-cal" style="font-family:'DM Serif Display',serif;font-size:1.4rem">0</div></div>
        </div>
      </div>
    </div>

    <div class="wellness-divider"></div>

    <!-- Section label -->
    <div class="wellness-section-label">üåô Sleep</div>
    <div class="section-layout" style="margin-bottom:1.5rem">
      <div class="section-box">
        <h3><span class="dot" style="background:var(--sleep)"></span>Log Sleep</h3>
        <div class="form-row">
          <input type="time" id="sleep-start" value="23:00" />
          <input type="time" id="sleep-end" value="07:00" />
        </div>
        <div style="margin: 0.8rem 0">
          <div class="card-label" style="margin-bottom:0.4rem">Sleep Quality: <span id="quality-val">5</span>/10</div>
          <input type="range" id="sleep-quality" min="1" max="10" value="5" oninput="document.getElementById('quality-val').textContent=this.value">
          <div class="range-labels"><span>Poor</span><span>Excellent</span></div>
        </div>
        <button class="btn-add" onclick="saveSleep()">Save Sleep</button>
        <div style="margin-top:1.2rem" id="sleep-display">
          <div class="empty-state">No sleep logged for today</div>
        </div>
      </div>
      <div class="section-box">
        <h3>Sleep Quality Trend</h3>
        <div class="chart-wrap"><canvas id="chartSleep"></canvas></div>
        <div style="margin-top:0.8rem">
          <div class="card-label">Average this week</div>
          <div id="avg-sleep" style="font-family:'DM Serif Display',serif;font-size:1.4rem;margin-top:0.3rem">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="wellness-divider"></div>

    <!-- Section label -->
    <div class="wellness-section-label">‚úì Habits</div>
    <div class="section-layout">
      <div class="section-box">
        <h3><span class="dot" style="background:var(--habit)"></span>Today's Habits</h3>
        <div class="form-row">
          <input type="text" id="new-habit" placeholder="Add a new habit‚Ä¶" />
          <button class="btn-add" onclick="addHabit()">+ Add</button>
        </div>
        <div class="habit-grid" id="habit-grid"></div>
      </div>
      <div class="section-box">
        <h3>Habit Completion</h3>
        <div class="chart-wrap"><canvas id="chartHabit"></canvas></div>
        <div style="margin-top:0.8rem" id="habit-summary">
          <div class="empty-state">No habits yet</div>
        </div>
      </div>
    </div>

  </div>

  <!-- NOTES -->
  <div class="panel" id="panel-notes">
    <div class="section-layout">
      <div class="section-box" style="grid-column: 1/-1">
        <h3><span class="dot" style="background:var(--ink2)"></span>Daily Notes</h3>
        <textarea id="notes-text" placeholder="Write anything ‚Äî thoughts, reflections, things to remember‚Ä¶"></textarea>
        <br><button class="save-btn" onclick="saveNotes()">Save Notes</button>
        <div style="margin-top:1.2rem" id="saved-note-display"></div>
      </div>
    </div>
  </div>

  <!-- WEEKLY -->
  <div class="panel" id="panel-weekly">
    <div class="weekly-grid">
      <div class="chart-box">
        <h3>Calories (7 days)</h3>
        <div class="chart-wrap"><canvas id="chartWeekCal"></canvas></div>
      </div>
      <div class="chart-box">
        <h3>Expenses (7 days)</h3>
        <div class="chart-wrap"><canvas id="chartWeekExp"></canvas></div>
      </div>
      <div class="chart-box">
        <h3>Exercise Minutes (7 days)</h3>
        <div class="chart-wrap"><canvas id="chartWeekSport"></canvas></div>
      </div>
      <div class="chart-box">
        <h3>Sleep Duration (7 days)</h3>
        <div class="chart-wrap"><canvas id="chartWeekSleep"></canvas></div>
      </div>
    </div>
  </div>

  <!-- TO-DO -->
  <div class="panel" id="panel-todo">
    <div class="todo-layout">

      <!-- LEFT: Add task + daily tasks -->
      <div class="section-box">
        <h3><span class="dot" style="background:var(--habit)"></span>Add Task</h3>

        <div class="form-row">
          <input type="text" id="todo-title" placeholder="What needs to be done?" />
        </div>
        <div class="form-row">
          <select id="todo-priority">
            <option value="high">üî¥ High</option>
            <option value="medium" selected>üü° Medium</option>
            <option value="low">üü¢ Low</option>
          </select>
          <select id="todo-type">
            <option value="daily">üìÖ Daily task</option>
            <option value="backlog">üìå Backlog</option>
          </select>
        </div>
        <div class="form-row">
          <input type="text" id="todo-category" placeholder="Category / tag (e.g. Work, Health)" />
          <input type="date" id="todo-due" />
        </div>
        <button class="btn-add" onclick="addTodo()" style="width:100%;justify-content:center;display:flex">+ Add Task</button>

        <div class="todo-section-title" style="margin-top:1.4rem">Today's Tasks</div>
        <div class="filter-bar" id="filter-bar-daily">
          <button class="filter-btn active" onclick="setFilter('daily','all',this)">All</button>
          <button class="filter-btn" onclick="setFilter('daily','high',this)">üî¥ High</button>
          <button class="filter-btn" onclick="setFilter('daily','medium',this)">üü° Medium</button>
          <button class="filter-btn" onclick="setFilter('daily','low',this)">üü¢ Low</button>
        </div>
        <div id="todo-daily-list"></div>
      </div>

      <!-- RIGHT: Stats + Backlog -->
      <div>
        <!-- Stats -->
        <div class="section-box" style="margin-bottom:1.2rem">
          <h3>Progress</h3>
          <div class="todo-stats">
            <div class="todo-stat"><div class="num" id="stat-today-done">0</div><div class="lbl">Done today</div></div>
            <div class="todo-stat"><div class="num" id="stat-today-total">0</div><div class="lbl">Total today</div></div>
            <div class="todo-stat"><div class="num" id="stat-backlog">0</div><div class="lbl">In backlog</div></div>
            <div class="todo-stat"><div class="num" id="stat-overdue">0</div><div class="lbl">Overdue</div></div>
          </div>
          <div style="background:var(--surface2);border-radius:20px;height:8px;overflow:hidden;margin-top:0.3rem">
            <div id="todo-progress-bar" style="height:100%;background:var(--sport);border-radius:20px;transition:width 0.4s;width:0%"></div>
          </div>
          <div id="todo-progress-label" style="font-size:0.62rem;color:var(--ink3);margin-top:0.4rem">0% complete</div>
        </div>

        <!-- Backlog -->
        <div class="section-box">
          <h3>üìå Backlog</h3>
          <div class="filter-bar" id="filter-bar-backlog">
            <button class="filter-btn active" onclick="setFilter('backlog','all',this)">All</button>
            <button class="filter-btn" onclick="setFilter('backlog','high',this)">üî¥ High</button>
            <button class="filter-btn" onclick="setFilter('backlog','medium',this)">üü° Medium</button>
            <button class="filter-btn" onclick="setFilter('backlog','low',this)">üü¢ Low</button>
          </div>
          <div id="todo-backlog-list"></div>
        </div>
      </div>

    </div>
  </div>


</div>

<script type="module">
// ‚îÄ‚îÄ‚îÄ FIREBASE SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
import { initializeApp }                            from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc,
         collection, getDocs, addDoc, updateDoc,
         deleteDoc, onSnapshot, writeBatch, query,
         orderBy, serverTimestamp }                 from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, GoogleAuthProvider,
         signInWithPopup, signOut,
         onAuthStateChanged }                       from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey:            "AIzaSyBeReQ2PUHr7QzCYh0CWoOO47MGp99vkmA",
  authDomain:        "daily-tracker-d6e6d.firebaseapp.com",
  projectId:         "daily-tracker-d6e6d",
  storageBucket:     "daily-tracker-d6e6d.firebasestorage.app",
  messagingSenderId: "966708478409",
  appId:             "1:966708478409:web:320fa3dc6edfd21bcde818"
};

const fbApp    = initializeApp(firebaseConfig);
const db       = getFirestore(fbApp);
const auth     = getAuth(fbApp);
const provider = new GoogleAuthProvider();

let USER = null; // set after sign-in

// --- AUTH ---
function showApp(user) {
  USER = user.uid;
  document.getElementById('auth-screen').style.display  = 'none';
  document.getElementById('app-wrapper').style.display  = 'block';
  const avatarEl = document.getElementById('user-avatar');
  if (avatarEl) {
    avatarEl.src   = user.photoURL || '';
    avatarEl.style.display = user.photoURL ? 'inline-block' : 'none';
  }
  const nameEl = document.getElementById('user-name');
  if (nameEl) nameEl.textContent = user.displayName || user.email || '';
  _cache = {}; _todosCache = null; _recipesCache = null;
  _rbRecipesCache = null; _libraryCache = null; _mealPlanCache = null;
  updateDateDisplay();
  renderAll();
}

function hideApp() {
  USER = null;
  document.getElementById('auth-screen').style.display  = 'flex';
  document.getElementById('app-wrapper').style.display  = 'none';
}

async function googleSignIn() {
  const btn = document.getElementById('signin-btn');
  if (btn) { btn.textContent = 'Signing in...'; btn.disabled = true; }
  try {
    await signInWithPopup(auth, provider);
  } catch(e) {
    console.error('Sign-in error', e);
    if (btn) { btn.textContent = 'Sign in with Google'; btn.disabled = false; }
    alert('Sign-in failed: ' + (e.message || e));
  }
}

async function googleSignOut() {
  if (!confirm('Sign out?')) return;
  await signOut(auth);
}

onAuthStateChanged(auth, user => {
  if (user) showApp(user);
  else hideApp();
});


// ‚îÄ‚îÄ‚îÄ SYNC STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSync(msg, color = '#3abf72') {
  let el = document.getElementById('sync-indicator');
  if (!el) return;
  el.textContent = msg;
  el.style.color = color;
  el.style.opacity = '1';
  clearTimeout(el._t);
  el._t = setTimeout(() => { el.style.opacity = '0'; }, 2000);
}

// ‚îÄ‚îÄ‚îÄ LOCAL CACHE (keeps UI snappy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _cache = {};           // dateKey ‚Üí day object
let _todosCache    = null;
let _recipesCache  = null;
let _rbRecipesCache = null;
let _libraryCache  = null;

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentDate = new Date();
currentDate.setHours(0,0,0,0);

function dateKey(d) {
  return d.toISOString().slice(0,10);
}

// ‚îÄ‚îÄ Day document helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function emptyDay() {
  return { food:[], expenses:[], sport:[], sleep:null, habits:{}, habitDefs:[], notes:'' };
}

async function getDay(key) {
  if (_cache[key]) return JSON.parse(JSON.stringify(_cache[key]));
  try {
    const snap = await getDoc(doc(db, "users", USER, "days", key));
    const data = snap.exists() ? snap.data() : emptyDay();
    // Firestore stores arrays fine; ensure defaults
    if (!data.food)       data.food = [];
    if (!data.expenses)   data.expenses = [];
    if (!data.sport)      data.sport = [];
    if (!data.habits)     data.habits = {};
    if (!data.habitDefs)  data.habitDefs = [];
    if (data.sleep === undefined) data.sleep = null;
    if (!data.notes)      data.notes = '';
    _cache[key] = JSON.parse(JSON.stringify(data));
    return data;
  } catch(e) {
    console.error('getDay error', e);
    return emptyDay();
  }
}

async function setDay(key, val) {
  _cache[key] = JSON.parse(JSON.stringify(val));
  showSync('saving‚Ä¶', '#e8b83a');
  try {
    await setDoc(doc(db, "users", USER, "days", key), val);
    showSync('‚úì saved');
  } catch(e) {
    console.error('setDay error', e);
    showSync('‚ö† save failed', '#e8623a');
  }
}

// Backwards-compat shim for synchronous callers (weekly chart etc.)
// We pre-load the cache for the 7-day window on each renderWeekly call
function getDaySync(key) {
  return _cache[key] ? JSON.parse(JSON.stringify(_cache[key])) : emptyDay();
}

async function preloadWeekCache() {
  const days = getLast7Days();
  await Promise.all(days.map(d => getDay(dateKey(d))));
}

// ‚îÄ‚îÄ Todos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getTodos() {
  if (_todosCache) return JSON.parse(JSON.stringify(_todosCache));
  try {
    const snap = await getDocs(collection(db, "users", USER, "todos"));
    const todos = snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
    todos.sort((a,b) => (b.id||0) - (a.id||0));
    _todosCache = todos;
    return JSON.parse(JSON.stringify(todos));
  } catch(e) {
    console.error('getTodos error', e);
    return [];
  }
}

async function saveTodos(todos) {
  _todosCache = JSON.parse(JSON.stringify(todos));
  // We do individual doc writes; this is called after local mutation
  // (actual Firestore writes happen in add/toggle/delete functions)
}

// ‚îÄ‚îÄ Recipes (Meals) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getRecipes() {
  if (_recipesCache) return JSON.parse(JSON.stringify(_recipesCache));
  try {
    const snap = await getDocs(collection(db, "users", USER, "recipes"));
    const recipes = snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
    recipes.sort((a,b) => (b.id||0) - (a.id||0));
    _recipesCache = recipes;
    return JSON.parse(JSON.stringify(recipes));
  } catch(e) {
    console.error('getRecipes error', e);
    return [];
  }
}

async function saveRecipesToFS(recipes) {
  _recipesCache = JSON.parse(JSON.stringify(recipes));
}

// ‚îÄ‚îÄ Recipe Book ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getRbRecipes() {
  if (_rbRecipesCache) return JSON.parse(JSON.stringify(_rbRecipesCache));
  try {
    const snap = await getDocs(collection(db, "users", USER, "rbRecipes"));
    const recs = snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
    recs.sort((a,b) => (b.id||0) - (a.id||0));
    _rbRecipesCache = recs;
    return JSON.parse(JSON.stringify(recs));
  } catch(e) {
    console.error('getRbRecipes error', e);
    return [];
  }
}

async function saveRbRecipesToFS(recipes) {
  _rbRecipesCache = JSON.parse(JSON.stringify(recipes));
}

// ‚îÄ‚îÄ Food Library ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getFoodLibrary() {
  if (_libraryCache) return JSON.parse(JSON.stringify(_libraryCache));
  try {
    const snap = await getDoc(doc(db, "users", USER, "meta", "foodLibrary"));
    const lib = snap.exists() ? (snap.data().items || []) : [];
    _libraryCache = lib;
    return JSON.parse(JSON.stringify(lib));
  } catch(e) {
    console.error('getFoodLibrary error', e);
    return [];
  }
}

async function saveFoodLibrary(lib) {
  _libraryCache = JSON.parse(JSON.stringify(lib));
  showSync('saving‚Ä¶', '#e8b83a');
  try {
    await setDoc(doc(db, "users", USER, "meta", "foodLibrary"), { items: lib });
    showSync('‚úì saved');
  } catch(e) {
    showSync('‚ö† save failed', '#e8623a');
  }
}

// ‚îÄ‚îÄ‚îÄ DATE NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function changeDay(delta) {
  currentDate.setDate(currentDate.getDate() + delta);
  updateDateDisplay();
  renderAll();
}

function updateDateDisplay() {
  const opts = { weekday:'short', month:'short', day:'numeric' };
  const today = new Date(); today.setHours(0,0,0,0);
  let label = currentDate.toLocaleDateString('en-US', opts);
  if (currentDate.getTime() === today.getTime()) label = 'Today ¬∑ ' + label;
  document.getElementById('currentDateDisplay').textContent = label;
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  event.target.classList.add('active');
  renderAll();
}

// ‚îÄ‚îÄ‚îÄ FOOD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ FOOD SUB-TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchFoodTab(name, btn) {
  document.getElementById('sfood-log').style.display         = name==='log'         ? '' : 'none';
  document.getElementById('sfood-recipe').style.display      = name==='recipe'      ? '' : 'none';
  document.getElementById('sfood-recipebook').style.display  = name==='recipebook'  ? '' : 'none';
  document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (name === 'recipe')      renderRecipeList();
  if (name === 'recipebook')  renderRecipeBook();
}

// ‚îÄ‚îÄ‚îÄ RECIPE STORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// getRecipes() and saveRecipesToFS() are defined above in Firebase section

// Temp ingredient / step builders
let tempIngredients = [];
let tempSteps = [];

function addIngredient() {
  const name = document.getElementById('ing-name').value.trim();
  const qty  = document.getElementById('ing-qty').value.trim();
  if (!name) return;
  tempIngredients.push({ id: Date.now(), name, qty });
  document.getElementById('ing-name').value = '';
  document.getElementById('ing-qty').value  = '';
  renderIngBuilderList();
}

function removeIngredient(id) {
  tempIngredients = tempIngredients.filter(i => i.id !== id);
  renderIngBuilderList();
}

function renderIngBuilderList() {
  const el = document.getElementById('recipe-ingredients-list');
  if (!el) return;
  el.innerHTML = tempIngredients.map(i => `
    <div class="ing-item-build">
      <span>${i.name}${i.qty ? ' ‚Äî ' + i.qty : ''}</span>
      <button class="ing-del" onclick="removeIngredient(${i.id})">‚úï</button>
    </div>`).join('');
}

function addStep() {
  const text = document.getElementById('step-text').value.trim();
  if (!text) return;
  tempSteps.push({ id: Date.now(), text });
  document.getElementById('step-text').value = '';
  renderStepsBuilderList();
}

function removeStep(id) {
  tempSteps = tempSteps.filter(s => s.id !== id);
  renderStepsBuilderList();
}

function renderStepsBuilderList() {
  const el = document.getElementById('recipe-steps-list');
  if (!el) return;
  el.innerHTML = tempSteps.map((s, i) => `
    <div class="step-item-build">
      <span style="color:var(--ink3);font-size:0.65rem;min-width:16px">${i+1}.</span>
      <span>${s.text}</span>
      <button class="step-del" onclick="removeStep(${s.id})">‚úï</button>
    </div>`).join('');
}

async function saveRecipe() {
  const name     = document.getElementById('recipe-name').value.trim();
  const category = document.getElementById('recipe-category').value.trim();
  const servings = parseInt(document.getElementById('recipe-servings').value) || 1;
  const cal      = parseFloat(document.getElementById('recipe-cal').value)     || 0;
  const protein  = parseFloat(document.getElementById('recipe-protein').value) || 0;
  const carbs    = parseFloat(document.getElementById('recipe-carbs').value)   || 0;
  const fat      = parseFloat(document.getElementById('recipe-fat').value)     || 0;
  const editId   = document.getElementById('recipe-edit-id').value;

  if (!name) { alert('Please enter a recipe name'); return; }

  const recipes = await getRecipes();
  const recipe = {
    id: editId ? parseInt(editId) : Date.now(),
    name, category, servings, cal, protein, carbs, fat,
    ingredients: [...tempIngredients],
    steps: [...tempSteps],
    createdAt: editId ? (recipes.find(r=>r.id===parseInt(editId))||{}).createdAt : new Date().toISOString()
  };

  showSync('saving‚Ä¶', '#e8b83a');
  try {
    if (editId) {
      const existing = recipes.find(r => r.id === parseInt(editId));
      if (existing && existing.firestoreId) {
        await updateDoc(doc(db, "users", USER, "recipes", existing.firestoreId), recipe);
      } else {
        await addDoc(collection(db, "users", USER, "recipes"), recipe);
      }
    } else {
      await addDoc(collection(db, "users", USER, "recipes"), recipe);
    }
    _recipesCache = null; // invalidate cache
    showSync('‚úì saved');
  } catch(e) {
    console.error('saveRecipe error', e);
    showSync('‚ö† save failed', '#e8623a');
    return;
  }

  clearRecipeForm();
  renderRecipeList();

  const btn = document.querySelector('[onclick="saveRecipe()"]');
  if (btn) { btn.textContent = '‚úì Saved!'; setTimeout(() => { btn.innerHTML = '&#128190; Save Recipe'; }, 1200); }
}

function clearRecipeForm() {
  ['recipe-name','recipe-category','recipe-cal','recipe-protein','recipe-carbs','recipe-fat','recipe-edit-id'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  document.getElementById('recipe-servings').value = '1';
  document.getElementById('recipe-form-title').textContent = 'New Recipe';
  tempIngredients = []; tempSteps = [];
  renderIngBuilderList(); renderStepsBuilderList();
}

async function editRecipe(id) {
  const recipes = await getRecipes();
  const r = recipes.find(r => r.id === id);
  if (!r) return;
  document.getElementById('recipe-edit-id').value   = r.id;
  document.getElementById('recipe-name').value      = r.name;
  document.getElementById('recipe-category').value  = r.category || '';
  document.getElementById('recipe-servings').value  = r.servings || 1;
  document.getElementById('recipe-cal').value       = r.cal || '';
  document.getElementById('recipe-protein').value   = r.protein || '';
  document.getElementById('recipe-carbs').value     = r.carbs || '';
  document.getElementById('recipe-fat').value       = r.fat || '';
  document.getElementById('recipe-form-title').textContent = 'Edit Recipe';
  tempIngredients = [...(r.ingredients||[])];
  tempSteps = [...(r.steps||[])];
  renderIngBuilderList(); renderStepsBuilderList();
  document.getElementById('recipe-name').scrollIntoView({ behavior:'smooth', block:'center' });
}

async function deleteRecipe(id) {
  if (!confirm('Delete this recipe?')) return;
  const recipes = await getRecipes();
  const r = recipes.find(r => r.id === id);
  if (r && r.firestoreId) {
    showSync('saving‚Ä¶', '#e8b83a');
    try {
      await deleteDoc(doc(db, "users", USER, "recipes", r.firestoreId));
      _recipesCache = null;
      showSync('‚úì deleted');
    } catch(e) { showSync('‚ö† failed', '#e8623a'); return; }
  }
  renderRecipeList();
}

function logRecipeAsFood(r) {
  // Switch to food log sub-tab and pre-fill
  switchFoodTab('log', document.getElementById('stab-log'));
  document.getElementById('food-name').value    = r.name;
  document.getElementById('food-cal').value     = r.cal;
  document.getElementById('food-protein').value = r.protein;
  document.getElementById('food-carbs').value   = r.carbs;
  document.getElementById('food-fat').value     = r.fat;
  document.getElementById('food-meal').focus();
}

let openRecipeId = null;
let mealView = 'grid';
let mealCatFilter = 'all';

function setMealView(v, btn) {
  mealView = v;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderRecipeList();
}

function setMealCat(cat, btn) {
  mealCatFilter = cat;
  document.querySelectorAll('.meal-cat-pill').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderRecipeList();
}

function openMealForm(id) {
  if (id) editRecipe(id);
  else clearRecipeForm();
  document.getElementById('meal-modal-overlay').classList.add('open');
}

function closeMealForm(e) {
  if (e && e.target !== document.getElementById('meal-modal-overlay') && e.type === 'click') return;
  document.getElementById('meal-modal-overlay').classList.remove('open');
}

function toggleRecipeDetail(id) {
  openRecipeId = openRecipeId === id ? null : id;
  renderRecipeList();
}

async function renderRecipeList() {
  const el = document.getElementById('recipe-list');
  if (!el) return;

  const q = (document.getElementById('recipe-search')||{}).value || '';
  let recipes = await getRecipes();

  // Render category pills
  const catsEl = document.getElementById('meal-cats');
  if (catsEl) {
    const cats = [...new Set(recipes.map(r => r.category).filter(Boolean))];
    catsEl.innerHTML = `<button class="meal-cat-pill ${mealCatFilter==='all'?'active':''}" onclick="setMealCat('all',this)">All</button>` +
      cats.map(c => `<button class="meal-cat-pill ${mealCatFilter===c?'active':''}" onclick="setMealCat('${c.replace(/'/g,"\\'")}',this)">${c}</button>`).join('');
  }

  // Filter
  if (q) recipes = recipes.filter(r => r.name.toLowerCase().includes(q.toLowerCase()) || (r.category||'').toLowerCase().includes(q.toLowerCase()));
  if (mealCatFilter !== 'all') recipes = recipes.filter(r => r.category === mealCatFilter);

  if (!recipes.length) {
    el.innerHTML = '<div class="empty-state" style="padding:2rem">No meals found.<br>Click <strong>+ New Meal</strong> to create one!</div>';
    renderMealPlanner();
    return;
  }

  const actionsHTML = (r) => `
    <button class="log-btn" onclick='logRecipeAsFood(${JSON.stringify(r).replace(/'/g,"&#39;")})'>&#128203; Log</button>
    <button onclick="openMealForm(${r.id})">&#9998;</button>
    <button onclick="deleteRecipe(${r.id})">&#10005;</button>`;

  if (mealView === 'grid') {
    el.innerHTML = `<div class="meal-grid">` + recipes.map((r,i) => `
      <div class="meal-grid-card" style="animation-delay:${i*0.04}s">
        <div class="meal-grid-card-color"></div>
        <div class="meal-grid-card-body">
          <div class="meal-grid-card-name">${r.name}</div>
          <div class="meal-grid-card-cat">${r.category||'Uncategorised'} &middot; ${r.servings} serving${r.servings>1?'s':''}</div>
          <div class="meal-grid-macros">
            <span class="meal-macro-badge">${r.cal} kcal</span>
            <span class="meal-macro-badge">P ${r.protein}g</span>
            <span class="meal-macro-badge">C ${r.carbs}g</span>
            <span class="meal-macro-badge">F ${r.fat}g</span>
          </div>
        </div>
        <div class="meal-grid-card-actions">${actionsHTML(r)}</div>
      </div>`).join('') + `</div>`;
  } else {
    // List view with expandable detail
    el.innerHTML = `<table class="meal-list-table">
      <thead><tr>
        <th>Name</th><th>Category</th><th>Cal</th><th>Protein</th><th>Carbs</th><th>Fat</th><th></th>
      </tr></thead>
      <tbody>` + recipes.map(r => {
        const isOpen = openRecipeId === r.id;
        const ingsHTML = (r.ingredients||[]).length ? `<div class="recipe-detail-section">Ingredients</div>${(r.ingredients).map(i=>`<div class="recipe-ing-item"><span style="color:var(--ink3)">‚Ä¢</span><span>${i.name}${i.qty?' ‚Äî '+i.qty:''}</span></div>`).join('')}` : '';
        const stepsHTML = (r.steps||[]).length ? `<div class="recipe-detail-section">Steps</div>${(r.steps).map((s,i)=>`<div class="recipe-step-item"><div class="recipe-step-num">${i+1}</div><span>${s.text}</span></div>`).join('')}` : '';
        return `<tr class="meal-list-row" onclick="toggleRecipeDetail(${r.id})">
          <td><div class="ml-name">${r.name}</div></td>
          <td><div class="ml-cat">${r.category||'‚Äî'}</div></td>
          <td>${r.cal}</td><td>${r.protein}g</td><td>${r.carbs}g</td><td>${r.fat}g</td>
          <td onclick="event.stopPropagation()"><div class="meal-list-actions">${actionsHTML(r)}</div></td>
        </tr>
        ${isOpen && (ingsHTML||stepsHTML) ? `<tr><td colspan="7"><div class="recipe-detail open">${ingsHTML}${stepsHTML}</div></td></tr>` : ''}`;
      }).join('') + `</tbody></table>`;
  }

  renderMealPlanner();
}

// ‚îÄ‚îÄ MEAL PLANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _mealPlanCache = null;

async function getMealPlan() {
  if (_mealPlanCache) return JSON.parse(JSON.stringify(_mealPlanCache));
  try {
    const snap = await getDoc(doc(db, "users", USER, "meta", "mealPlan"));
    const plan = snap.exists() ? (snap.data().plan || {}) : {};
    _mealPlanCache = plan;
    return JSON.parse(JSON.stringify(plan));
  } catch(e) { return {}; }
}

async function saveMealPlan(p) {
  _mealPlanCache = JSON.parse(JSON.stringify(p));
  showSync('saving‚Ä¶', '#e8b83a');
  try {
    await setDoc(doc(db, "users", USER, "meta", "mealPlan"), { plan: p });
    showSync('‚úì saved');
  } catch(e) { showSync('‚ö† failed', '#e8623a'); }
}

async function renderMealPlanner() {
  const grid = document.getElementById('meal-planner-grid');
  if (!grid) return;
  const plan = await getMealPlan();
  const recipes = await getRecipes();
  const today = new Date(); today.setHours(0,0,0,0);

  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(today); d.setDate(today.getDate() + i); days.push(d);
  }

  grid.innerHTML = days.map(d => {
    const key = dateKey(d);
    const isToday = d.getTime() === today.getTime();
    const planned = plan[key] || [];
    const dayLabel = d.toLocaleDateString('en-US', { weekday: 'short' });
    const dayNum   = d.getDate();

    const chips = planned.map((name, idx) =>
      `<div class="planner-meal-chip" title="${name}">
        <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70px">${name}</span>
        <span class="chip-del" onclick="removePlanMeal('${key}',${idx});event.stopPropagation()">‚úï</span>
      </div>`).join('');

    const opts = recipes.map(r => `<option value="${r.name}">${r.name}</option>`).join('');

    return `<div class="planner-day ${isToday?'today':''}">
      <div class="planner-day-label">${dayLabel}</div>
      <div class="planner-day-date">${dayNum}</div>
      ${chips}
      <select class="planner-select" style="display:none" id="psel-${key}" onchange="addPlanMeal('${key}',this)">
        <option value="">Pick meal‚Ä¶</option>${opts}
      </select>
      <button class="planner-add-btn" onclick="togglePlanSelect('${key}')">+ add</button>
    </div>`;
  }).join('');
}

function togglePlanSelect(key) {
  const sel = document.getElementById('psel-' + key);
  if (!sel) return;
  sel.style.display = sel.style.display === 'none' ? 'block' : 'none';
}

async function addPlanMeal(key, sel) {
  if (!sel.value) return;
  const plan = await getMealPlan();
  if (!plan[key]) plan[key] = [];
  plan[key].push(sel.value);
  await saveMealPlan(plan);
  sel.value = ''; sel.style.display = 'none';
  renderMealPlanner();
}

async function removePlanMeal(key, idx) {
  const plan = await getMealPlan();
  if (plan[key]) { plan[key].splice(idx, 1); if (!plan[key].length) delete plan[key]; }
  await saveMealPlan(plan);
  renderMealPlanner();
}

// ‚îÄ‚îÄ‚îÄ FOOD LIBRARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// getFoodLibrary() and saveFoodLibrary() are defined above in Firebase section

async function saveToLibrary() {
  const name = document.getElementById('food-name').value.trim();
  const cal = parseFloat(document.getElementById('food-cal').value) || 0;
  const protein = parseFloat(document.getElementById('food-protein').value) || 0;
  const carbs = parseFloat(document.getElementById('food-carbs').value) || 0;
  const fat = parseFloat(document.getElementById('food-fat').value) || 0;
  if (!name) { alert('Please enter a food name first'); return; }
  const lib = await getFoodLibrary();
  // Avoid duplicates by name (case-insensitive)
  if (lib.find(f => f.name.toLowerCase() === name.toLowerCase())) {
    if (!confirm(name + ' is already in your library. Update it?')) return;
    const idx = lib.findIndex(f => f.name.toLowerCase() === name.toLowerCase());
    lib[idx] = { name, cal, protein, carbs, fat, id: lib[idx].id };
  } else {
    lib.unshift({ name, cal, protein, carbs, fat, id: Date.now() });
  }
  await saveFoodLibrary(lib);
  renderLibrary();
  // Flash feedback
  const btn = event.target;
  btn.textContent = '‚úì Saved!';
  setTimeout(() => { btn.innerHTML = '&#128190; Save to Library'; }, 1200);
}

async function deleteFoodFromLibrary(id) {
  const lib = (await getFoodLibrary()).filter(f => f.id !== id);
  await saveFoodLibrary(lib);
  renderLibrary();
}

function fillFromLibrary(item) {
  document.getElementById('food-name').value = item.name;
  document.getElementById('food-cal').value = item.cal || '';
  document.getElementById('food-protein').value = item.protein || '';
  document.getElementById('food-carbs').value = item.carbs || '';
  document.getElementById('food-fat').value = item.fat || '';
  // Close dropdown
  document.getElementById('food-dropdown').style.display = 'none';
  document.getElementById('food-search').value = '';
  // Focus meal field
  document.getElementById('food-meal').focus();
}

async function renderLibrary() {
  const lib = await getFoodLibrary();
  const el = document.getElementById('library-list');
  if (!el) return;
  if (!lib.length) {
    el.innerHTML = '<div class="empty-state">No saved foods yet.<br>Fill in a food and click<br>\'Save to Library\'</div>';
    return;
  }
  el.innerHTML = lib.map(f => `
    <div class="lib-item" onclick="fillFromLibrary(${JSON.stringify(f).replace(/"/g,'&quot;')})">
      <div style="flex:1;min-width:0">
        <div class="lib-item-name">${f.name}</div>
        <div class="lib-item-meta">${f.cal} kcal ¬∑ P${f.protein}g ¬∑ C${f.carbs}g ¬∑ F${f.fat}g</div>
      </div>
      <button class="lib-del" onclick="event.stopPropagation();deleteFoodFromLibrary(${f.id})" title="Remove">‚úï</button>
    </div>`).join('');
}

async function filterLibrary() {
  const q = document.getElementById('food-search').value.trim().toLowerCase();
  const dropdown = document.getElementById('food-dropdown');
  if (!q) { dropdown.style.display = 'none'; return; }
  const lib = await getFoodLibrary();
  const matches = lib.filter(f => f.name.toLowerCase().includes(q));
  if (!matches.length) { dropdown.style.display = 'none'; return; }
  dropdown.style.display = 'block';
  dropdown.innerHTML = matches.map(f => `
    <div class="drop-item" onclick="fillFromLibrary(${JSON.stringify(f).replace(/"/g,'&quot;')})">
      <span>${f.name}</span>
      <span class="drop-item-meta">${f.cal} kcal</span>
    </div>`).join('');
}

// Close dropdown on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('#food-dropdown') && e.target.id !== 'food-search') {
    const dd = document.getElementById('food-dropdown');
    if (dd) dd.style.display = 'none';
  }
});

async function addFood() {
  const name = document.getElementById('food-name').value.trim();
  const cal = parseFloat(document.getElementById('food-cal').value) || 0;
  const meal = document.getElementById('food-meal').value || 'Meal';
  const protein = parseFloat(document.getElementById('food-protein').value) || 0;
  const carbs = parseFloat(document.getElementById('food-carbs').value) || 0;
  const fat = parseFloat(document.getElementById('food-fat').value) || 0;
  if (!name) return;
  const key = dateKey(currentDate);
  const day = await getDay(key);
  day.food.push({ name, cal, meal, protein, carbs, fat, id: Date.now() });
  await setDay(key, day);
  ['food-name','food-cal','food-meal','food-protein','food-carbs','food-fat'].forEach(id => document.getElementById(id).value='');
  document.getElementById('food-search').value = '';
  renderFood(); renderDashboard();
}

async function deleteFood(id) {
  const key = dateKey(currentDate);
  const day = await getDay(key);
  day.food = day.food.filter(f => f.id !== id);
  await setDay(key, day);
  renderFood(); renderDashboard();
}

async function renderFood() {
  const key = dateKey(currentDate);
  const day = await getDay(key);
  const list = document.getElementById('food-list');
  if (!day.food.length) { list.innerHTML = '<div class="empty-state">No food logged yet</div>'; }
  else list.innerHTML = day.food.map(f => `
    <div class="log-item">
      <span class="log-name">${f.name} <span style="color:var(--ink3);font-size:0.65rem">${f.meal}</span></span>
      <span class="log-val">${f.cal} kcal</span>
      <button class="log-del" onclick="deleteFood(${f.id})">‚úï</button>
    </div>`).join('');

  const totCal = day.food.reduce((a,f)=>a+f.cal,0);
  const totP = day.food.reduce((a,f)=>a+f.protein,0);
  const totC = day.food.reduce((a,f)=>a+f.carbs,0);
  const totF = day.food.reduce((a,f)=>a+f.fat,0);
  document.getElementById('total-cal').textContent = Math.round(totCal);
  document.getElementById('total-protein').textContent = Math.round(totP)+'g';
  document.getElementById('total-carbs').textContent = Math.round(totC)+'g';
  document.getElementById('total-fat').textContent = Math.round(totF)+'g';

  renderFoodChart(totP, totC, totF);
}

let chartFood, chartExp, chartSport, chartSleep, chartHabit, chartDash;
let chartWeekCal, chartWeekExp, chartWeekSport, chartWeekSleep;

function renderFoodChart(p,c,f) {
  const ctx = document.getElementById('chartFood');
  if (!ctx) return;
  if (chartFood) chartFood.destroy();
  chartFood = new Chart(ctx, {
    type:'doughnut',
    data:{
      labels:['Protein','Carbs','Fat'],
      datasets:[{ data:[p||0,c||0,f||0], backgroundColor:['#e8623a','#3a8fe8','#e8b83a'], borderWidth:0 }]
    },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ font:{family:'DM Mono',size:10}, color:'#6b6154' }}}}
  });
}

// ‚îÄ‚îÄ‚îÄ EXPENSES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addExpense() {
  const desc = document.getElementById('exp-desc').value.trim();
  const amount = parseFloat(document.getElementById('exp-amount').value) || 0;
  const cat = document.getElementById('exp-cat').value;
  if (!desc || !amount) return;
  const key = dateKey(currentDate);
  const day = await getDay(key);
  day.expenses.push({ desc, amount, cat, id: Date.now() });
  await setDay(key, day);
  document.getElementById('exp-desc').value='';
  document.getElementById('exp-amount').value='';
  renderExpenses(); renderDashboard();
}

async function deleteExpense(id) {
  const key = dateKey(currentDate);
  const day = await getDay(key);
  day.expenses = day.expenses.filter(e => e.id !== id);
  await setDay(key, day);
  renderExpenses(); renderDashboard();
}

async function renderExpenses() {
  const key = dateKey(currentDate);
  const day = await getDay(key);
  const list = document.getElementById('exp-list');
  if (!day.expenses.length) { list.innerHTML = '<div class="empty-state">No expenses yet</div>'; }
  else list.innerHTML = day.expenses.map(e => `
    <div class="log-item">
      <span class="log-name">${e.desc} <span style="color:var(--ink3);font-size:0.65rem">${e.cat}</span></span>
      <span class="log-val">Rp ${Math.round(e.amount).toLocaleString('id-ID')}</span>
      <button class="log-del" onclick="deleteExpense(${e.id})">‚úï</button>
    </div>`).join('');

  const total = day.expenses.reduce((a,e)=>a+e.amount,0);
  document.getElementById('total-exp').textContent = 'Rp '+Math.round(total).toLocaleString('id-ID');
  renderExpChart(day.expenses);
}

function renderExpChart(expenses) {
  const ctx = document.getElementById('chartExp');
  if (!ctx) return;
  const cats = {};
  expenses.forEach(e => cats[e.cat]=(cats[e.cat]||0)+e.amount);
  const labels = Object.keys(cats);
  const vals = Object.values(cats);
  const colors = ['#e8623a','#3a8fe8','#3abf72','#9b6fe8','#e8b83a','#c84b2f','#6b6154'];
  if (chartExp) chartExp.destroy();
  chartExp = new Chart(ctx, {
    type:'doughnut',
    data:{ labels, datasets:[{ data:vals, backgroundColor:colors.slice(0,labels.length), borderWidth:0 }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ font:{family:'DM Mono',size:10}, color:'#6b6154' }}}}
  });
}

// ‚îÄ‚îÄ‚îÄ SPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addSport() {
  const name = document.getElementById('sport-name').value.trim();
  const dur = parseFloat(document.getElementById('sport-dur').value) || 0;
  const cal = parseFloat(document.getElementById('sport-cal').value) || 0;
  const intensity = document.getElementById('sport-intensity').value;
  const notes = document.getElementById('sport-notes').value;
  if (!name) return;
  const key = dateKey(currentDate);
  const day = await getDay(key);
  day.sport.push({ name, dur, cal, intensity, notes, id: Date.now() });
  await setDay(key, day);
  ['sport-name','sport-dur','sport-cal','sport-notes'].forEach(id => document.getElementById(id).value='');
  renderSport(); renderDashboard();
}

async function deleteSport(id) {
  const key = dateKey(currentDate);
  const day = await getDay(key);
  day.sport = day.sport.filter(s => s.id !== id);
  await setDay(key, day);
  renderSport(); renderDashboard();
}

async function renderSport() {
  const key = dateKey(currentDate);
  const day = await getDay(key);
  const list = document.getElementById('sport-list');
  if (!day.sport.length) { list.innerHTML = '<div class="empty-state">No exercise logged yet</div>'; }
  else list.innerHTML = day.sport.map(s => `
    <div class="log-item">
      <span class="log-name">${s.name} <span style="color:var(--ink3);font-size:0.65rem">${s.intensity}</span></span>
      <span class="log-val">${s.dur}min ¬∑ ${s.cal}kcal</span>
      <button class="log-del" onclick="deleteSport(${s.id})">‚úï</button>
    </div>`).join('');

  const totTime = day.sport.reduce((a,s)=>a+s.dur,0);
  const totCal = day.sport.reduce((a,s)=>a+s.cal,0);
  document.getElementById('total-sport-time').textContent = totTime+' min';
  document.getElementById('total-sport-cal').textContent = totCal;
  renderSportChart(day.sport);
}

function renderSportChart(sport) {
  const ctx = document.getElementById('chartSport');
  if (!ctx) return;
  if (chartSport) chartSport.destroy();
  const intensityColor = { Low:'#a8d5be', Moderate:'#3abf72', High:'#1e8a4c', Max:'#0d5c32' };
  chartSport = new Chart(ctx, {
    type:'bar',
    data:{
      labels: sport.map(s=>s.name),
      datasets:[{ label:'Minutes', data:sport.map(s=>s.dur), backgroundColor:sport.map(s=>intensityColor[s.intensity]||'#3abf72'), borderRadius:4, borderSkipped:false }]
    },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ x:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'},grid:{display:false}}, y:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'}}}}
  });
}

// ‚îÄ‚îÄ‚îÄ SLEEP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveSleep() {
  const start = document.getElementById('sleep-start').value;
  const end = document.getElementById('sleep-end').value;
  const quality = parseInt(document.getElementById('sleep-quality').value);
  const key = dateKey(currentDate);
  const day = await getDay(key);
  day.sleep = { start, end, quality };
  await setDay(key, day);
  renderSleep(); renderDashboard();
}

function calcSleepHours(start, end) {
  const [sh,sm] = start.split(':').map(Number);
  const [eh,em] = end.split(':').map(Number);
  let mins = (eh*60+em) - (sh*60+sm);
  if (mins < 0) mins += 1440;
  return mins/60;
}

async function renderSleep() {
  const key = dateKey(currentDate);
  const day = await getDay(key);
  const disp = document.getElementById('sleep-display');
  if (!day.sleep) {
    disp.innerHTML = '<div class="empty-state">No sleep logged for today</div>';
  } else {
    const hrs = calcSleepHours(day.sleep.start, day.sleep.end);
    disp.innerHTML = `
      <div class="sleep-visual">
        <svg class="sleep-arc" viewBox="0 0 80 80">
          <circle cx="40" cy="40" r="34" fill="none" stroke="#d6ceba" stroke-width="8"/>
          <circle cx="40" cy="40" r="34" fill="none" stroke="var(--sleep)" stroke-width="8"
            stroke-dasharray="${Math.min(hrs/10,1)*213.6} 213.6" stroke-linecap="round"
            transform="rotate(-90 40 40)"/>
        </svg>
        <div class="sleep-info">
          <div class="big">${hrs.toFixed(1)}h</div>
          <div class="sub">${day.sleep.start} ‚Üí ${day.sleep.end}</div>
          <div class="sub">Quality: ${day.sleep.quality}/10</div>
        </div>
      </div>`;
    if (document.getElementById('sleep-start')) {
      document.getElementById('sleep-start').value = day.sleep.start;
      document.getElementById('sleep-end').value = day.sleep.end;
      document.getElementById('sleep-quality').value = day.sleep.quality;
      document.getElementById('quality-val').textContent = day.sleep.quality;
    }
  }
  renderSleepChart();
}

async function renderSleepChart() {
  await preloadWeekCache();
  const days = getLast7Days();
  const labels = days.map(d => d.toLocaleDateString('en-US',{weekday:'short'}));
  const vals = days.map(d => {
    const day = getDaySync(dateKey(d));
    if (day && day.sleep && day.sleep.start && day.sleep.end) return parseFloat(calcSleepHours(day.sleep.start, day.sleep.end).toFixed(1));
    return null;
  });
  const ctx = document.getElementById('chartSleep');
  if (!ctx) return;
  if (chartSleep) chartSleep.destroy();
    data:{ labels, datasets:[{ label:'Hours', data:vals, borderColor:'var(--sleep)', backgroundColor:'rgba(155,111,232,0.1)', fill:true, tension:0.4, pointBackgroundColor:'var(--sleep)', spanGaps:true }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ x:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'},grid:{display:false}}, y:{min:0,max:12, ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'}}}}
  });

  const valsCleaned = vals.filter(v=>v!==null);
  const avg = valsCleaned.length ? (valsCleaned.reduce((a,b)=>a+b,0)/valsCleaned.length).toFixed(1) : '‚Äî';
  document.getElementById('avg-sleep').textContent = avg !== '‚Äî' ? avg+'h' : '‚Äî';
}

// ‚îÄ‚îÄ‚îÄ HABITS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addHabit() {
  const name = document.getElementById('new-habit').value.trim();
  if (!name) return;
  const key = dateKey(currentDate);
  const day = await getDay(key);
  if (!day.habitDefs) day.habitDefs = [];
  const hid = 'h'+Date.now();
  day.habitDefs.push({ name, id: hid });
  if (!day.habits) day.habits = {};
  day.habits[hid] = false;
  await setDay(key, day);
  document.getElementById('new-habit').value='';
  renderHabits(); renderDashboard();
}

async function toggleHabit(id) {
  const key = dateKey(currentDate);
  const day = await getDay(key);
  day.habits[id] = !day.habits[id];
  await setDay(key, day);
  renderHabits(); renderDashboard();
}

async function renderHabits() {
  const key = dateKey(currentDate);
  const day = await getDay(key);
  const grid = document.getElementById('habit-grid');
  if (!day.habitDefs || !day.habitDefs.length) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1">Add your first habit above</div>';
    document.getElementById('habit-summary').innerHTML = '<div class="empty-state">No habits yet</div>';
    return;
  }
  grid.innerHTML = day.habitDefs.map(h => {
    const done = day.habits[h.id];
    return `<div class="habit-item ${done?'done':''}" onclick="toggleHabit('${h.id}')">
      <div class="habit-check">${done?'‚úì':''}</div>
      <span class="habit-name">${h.name}</span>
    </div>`;
  }).join('');

  const total = day.habitDefs.length;
  const done = day.habitDefs.filter(h=>day.habits[h.id]).length;
  document.getElementById('habit-summary').innerHTML = `
    <div style="font-family:'DM Serif Display',serif;font-size:1.5rem">${done}/${total} done</div>
    <div style="font-size:0.65rem;color:var(--ink3);margin-top:0.3rem">${Math.round(done/total*100)||0}% completion rate</div>`;

  renderHabitChart(day);
}

function renderHabitChart(day) {
  const ctx = document.getElementById('chartHabit');
  if (!ctx || !day.habitDefs || !day.habitDefs.length) return;
  const total = day.habitDefs.length;
  const done = day.habitDefs.filter(h=>day.habits[h.id]).length;
  if (chartHabit) chartHabit.destroy();
  chartHabit = new Chart(ctx, {
    type:'doughnut',
    data:{ labels:['Done','Remaining'], datasets:[{ data:[done,total-done], backgroundColor:['#3abf72','#e8e0d0'], borderWidth:0 }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{enabled:false}}}
  });
}

// ‚îÄ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveNotes() {
  const text = document.getElementById('notes-text').value;
  const key = dateKey(currentDate);
  const day = await getDay(key);
  day.notes = text;
  await setDay(key, day);
  renderNotes();
}

async function renderNotes() {
  const key = dateKey(currentDate);
  const day = await getDay(key);
  const el = document.getElementById('notes-text');
  if (el) el.value = day.notes || '';
  const disp = document.getElementById('saved-note-display');
  if (disp) {
    if (day.notes) {
      disp.innerHTML = `<div style="font-size:0.6rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--ink3);margin-bottom:0.4rem">Saved</div><div class="saved-note">${escHtml(day.notes)}</div>`;
    } else disp.innerHTML = '';
  }
}

function escHtml(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderDashboard() {
  const key = dateKey(currentDate);
  const day = await getDay(key);

  // Calories
  const cal = Math.round(day.food.reduce((a,f)=>a+f.cal,0));
  document.getElementById('dash-cal').textContent = cal;
  document.getElementById('dash-cal-sub').textContent = day.food.length ? day.food.length+' items logged' : 'no entries yet';

  // Expenses
  const exp = day.expenses.reduce((a,e)=>a+e.amount,0);
  document.getElementById('dash-exp').textContent = 'Rp '+Math.round(exp).toLocaleString('id-ID');
  document.getElementById('dash-exp-sub').textContent = day.expenses.length ? day.expenses.length+' transactions' : 'no entries yet';

  // Sport
  const sportMin = day.sport.reduce((a,s)=>a+s.dur,0);
  document.getElementById('dash-sport').textContent = sportMin+' min';
  document.getElementById('dash-sport-sub').textContent = day.sport.length ? day.sport.length+' activities' : 'no entries yet';

  // Sleep
  if (day.sleep) {
    const hrs = calcSleepHours(day.sleep.start, day.sleep.end);
    document.getElementById('dash-sleep').textContent = hrs.toFixed(1)+'h';
    document.getElementById('dash-sleep-sub').textContent = 'Quality: '+day.sleep.quality+'/10';
  } else {
    document.getElementById('dash-sleep').textContent = '‚Äî';
    document.getElementById('dash-sleep-sub').textContent = 'not logged';
  }

  // Habits
  if (day.habitDefs && day.habitDefs.length) {
    const total = day.habitDefs.length;
    const done = day.habitDefs.filter(h=>day.habits[h.id]).length;
    document.getElementById('dash-habits').textContent = done+'/'+total;
    document.getElementById('dash-habits-sub').textContent = Math.round(done/total*100)+'% complete';
  }

  renderDashChart(day);
}

function renderDashChart(day) {
  const ctx = document.getElementById('chartDash');
  if (!ctx) return;
  const cal = Math.round(day.food.reduce((a,f)=>a+f.cal,0));
  const exp = Math.round(day.expenses.reduce((a,e)=>a+e.amount,0));
  const sport = day.sport.reduce((a,s)=>a+s.dur,0);
  const sleepQ = day.sleep ? day.sleep.quality*10 : 0;
  const habitPct = day.habitDefs && day.habitDefs.length ? Math.round(day.habitDefs.filter(h=>day.habits[h.id]).length/day.habitDefs.length*100) : 0;

  if (chartDash) chartDash.destroy();
  chartDash = new Chart(ctx, {
    type:'bar',
    data:{
      labels:['Calories (kcal)','Expenses (Rp)','Exercise (min)','Sleep quality (%)','Habits (%)'],
      datasets:[{ data:[cal,exp,sport,sleepQ,habitPct], backgroundColor:['var(--food)','var(--expense)','var(--sport)','var(--sleep)','var(--habit)'], borderRadius:4, borderSkipped:false }]
    },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ x:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'},grid:{display:false}}, y:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'}}}}
  });
}

// ‚îÄ‚îÄ‚îÄ WEEKLY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getLast7Days() {
  const days = [];
  for (let i=6;i>=0;i--) {
    const d = new Date(currentDate);
    d.setDate(d.getDate()-i);
    days.push(d);
  }
  return days;
}

async function renderWeekly() {
  await preloadWeekCache();
  const days = getLast7Days();
  const labels = days.map(d => d.toLocaleDateString('en-US',{weekday:'short'}));

  const cals   = days.map(d => { const day=getDaySync(dateKey(d)); return day ? Math.round((day.food||[]).reduce((a,f)=>a+f.cal,0)) : 0; });
  const exps   = days.map(d => { const day=getDaySync(dateKey(d)); return day ? Math.round((day.expenses||[]).reduce((a,e)=>a+e.amount,0)) : 0; });
  const sports = days.map(d => { const day=getDaySync(dateKey(d)); return day ? (day.sport||[]).reduce((a,s)=>a+s.dur,0) : 0; });
  const sleeps = days.map(d => { const day=getDaySync(dateKey(d)); return (day && day.sleep && day.sleep.start && day.sleep.end) ? parseFloat(calcSleepHours(day.sleep.start,day.sleep.end).toFixed(1)) : null; });

  const mkBar = (id, vals, color, label, ref) => {
    const ctx = document.getElementById(id); if(!ctx) return;
    if(ref && ref.chart) ref.chart.destroy();
    const c = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label, data:vals, backgroundColor:color, borderRadius:4, borderSkipped:false }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ x:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'},grid:{display:false}}, y:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'}}}}});
    if(ref) ref.chart = c;
  };
  const mkLine = (id, vals, color, label, ref) => {
    const ctx = document.getElementById(id); if(!ctx) return;
    if(ref && ref.chart) ref.chart.destroy();
    const c = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label, data:vals, borderColor:color, backgroundColor:color+'22', fill:true, tension:0.4, pointBackgroundColor:color, spanGaps:true }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ x:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'},grid:{display:false}}, y:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'}}}}});
    if(ref) ref.chart = c;
  };

  const refs = [{}];
  if(chartWeekCal) chartWeekCal.destroy();
  if(chartWeekExp) chartWeekExp.destroy();
  if(chartWeekSport) chartWeekSport.destroy();
  if(chartWeekSleep) chartWeekSleep.destroy();
  chartWeekCal   = new Chart(document.getElementById('chartWeekCal'),   { type:'bar',  data:{labels,datasets:[{label:'kcal',data:cals,  backgroundColor:'var(--food)',  borderRadius:4,borderSkipped:false}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'},grid:{display:false}},y:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'}}}}});
  chartWeekExp   = new Chart(document.getElementById('chartWeekExp'),   { type:'bar',  data:{labels,datasets:[{label:'Rp',   data:exps,  backgroundColor:'var(--expense)',borderRadius:4,borderSkipped:false}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'},grid:{display:false}},y:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'}}}}});
  chartWeekSport = new Chart(document.getElementById('chartWeekSport'), { type:'bar',  data:{labels,datasets:[{label:'min', data:sports, backgroundColor:'var(--sport)',  borderRadius:4,borderSkipped:false}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'},grid:{display:false}},y:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'}}}}});
  chartWeekSleep = new Chart(document.getElementById('chartWeekSleep'), { type:'line', data:{labels,datasets:[{label:'hrs', data:sleeps, borderColor:'var(--sleep)',backgroundColor:'rgba(155,111,232,0.1)',fill:true,tension:0.4,pointBackgroundColor:'var(--sleep)',spanGaps:true}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'},grid:{display:false}},y:{min:0,max:12,ticks:{font:{family:'DM Mono',size:10},color:'#6b6154'}}}}});
}

// ‚îÄ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ TO-DO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let todoFilters = { daily: 'all', backlog: 'all' };

// getTodos() and saveTodos() are defined above in Firebase section

async function addTodo() {
  const title = document.getElementById('todo-title').value.trim();
  if (!title) return;
  const priority = document.getElementById('todo-priority').value;
  const type     = document.getElementById('todo-type').value;
  const category = document.getElementById('todo-category').value.trim();
  const due      = document.getElementById('todo-due').value;
  const todo = {
    id: Date.now(),
    title, priority, type, category, due,
    done: false,
    subtasks: [],
    dateAdded: dateKey(currentDate)
  };
  showSync('saving‚Ä¶', '#e8b83a');
  try {
    await addDoc(collection(db, "users", USER, "todos"), todo);
    _todosCache = null; // invalidate
    showSync('‚úì saved');
  } catch(e) { showSync('‚ö† failed', '#e8623a'); return; }
  ['todo-title','todo-category','todo-due'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('todo-priority').value = 'medium';
  document.getElementById('todo-type').value = 'daily';
  renderTodos();
}

async function _todoUpdate(id, updater) {
  // Helper: get, mutate, save one todo doc
  const todos = await getTodos();
  const t = todos.find(t => t.id === id);
  if (!t) return;
  updater(t);
  if (t.firestoreId) {
    const { firestoreId, ...data } = t;
    showSync('saving‚Ä¶', '#e8b83a');
    try {
      await updateDoc(doc(db, "users", USER, "todos", firestoreId), data);
      _todosCache = null;
      showSync('‚úì saved');
    } catch(e) { showSync('‚ö† failed', '#e8623a'); }
  }
  renderTodos();
}

async function toggleTodo(id) {
  await _todoUpdate(id, t => t.done = !t.done);
}

async function deleteTodo(id) {
  const todos = await getTodos();
  const t = todos.find(t => t.id === id);
  if (t && t.firestoreId) {
    showSync('saving‚Ä¶', '#e8b83a');
    try {
      await deleteDoc(doc(db, "users", USER, "todos", t.firestoreId));
      _todosCache = null;
      showSync('‚úì deleted');
    } catch(e) { showSync('‚ö† failed', '#e8623a'); return; }
  }
  renderTodos();
}

async function moveTodo(id, newType) {
  await _todoUpdate(id, t => t.type = newType);
}

async function addSubtask(todoId) {
  const input = document.getElementById('sub-input-' + todoId);
  const text = input ? input.value.trim() : '';
  if (!text) return;
  await _todoUpdate(todoId, t => {
    if (!t.subtasks) t.subtasks = [];
    t.subtasks.push({ id: Date.now(), text, done: false });
  });
}

async function toggleSubtask(todoId, subId) {
  await _todoUpdate(todoId, t => {
    if (t.subtasks) { const s = t.subtasks.find(s => s.id === subId); if (s) s.done = !s.done; }
  });
}

async function deleteSubtask(todoId, subId) {
  await _todoUpdate(todoId, t => {
    t.subtasks = (t.subtasks||[]).filter(s => s.id !== subId);
  });
}

function setFilter(list, val, btn) {
  todoFilters[list] = val;
  const bar = document.getElementById('filter-bar-' + list);
  if (bar) bar.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderTodos();
}

function isOverdue(due) {
  if (!due) return false;
  const today = dateKey(new Date());
  return due < today;
}

function buildTodoItem(t) {
  const overdue = !t.done && isOverdue(t.due);
  const subtasksDone = (t.subtasks||[]).filter(s=>s.done).length;
  const subtasksTotal = (t.subtasks||[]).length;
  const moveBtn = t.type === 'daily'
    ? `<button class="todo-btn" onclick="moveTodo(${t.id},'backlog')" title="Move to Backlog">üìå</button>`
    : `<button class="todo-btn" onclick="moveTodo(${t.id},'daily')" title="Move to Today">üìÖ</button>`;

  const subtasksHTML = subtasksTotal ? `
    <div class="todo-subtasks">
      ${(t.subtasks||[]).map(s => `
        <div class="subtask-item ${s.done?'sub-done':''}">
          <div class="subtask-check" onclick="toggleSubtask(${t.id},${s.id})">${s.done?'‚úì':''}</div>
          <span>${s.text}</span>
          <button class="todo-btn" onclick="deleteSubtask(${t.id},${s.id})" style="margin-left:auto;font-size:0.6rem">‚úï</button>
        </div>`).join('')}
    </div>` : '';

  return `
    <div class="todo-item ${t.done?'done-item':''}" data-priority="${t.priority}">
      <div class="todo-top">
        <div class="todo-check" onclick="toggleTodo(${t.id})">${t.done?'‚úì':''}</div>
        <span class="todo-title" onclick="toggleTodo(${t.id})">${t.title}</span>
        <div class="todo-actions">
          ${moveBtn}
          <button class="todo-btn" onclick="deleteTodo(${t.id})">‚úï</button>
        </div>
      </div>
      <div class="todo-meta">
        <span class="priority-badge ${t.priority}">${t.priority}</span>
        ${t.category ? `<span class="todo-tag">${t.category}</span>` : ''}
        ${t.due ? `<span class="todo-due ${overdue?'overdue':''}">üìÖ ${overdue?'Overdue: ':''}${t.due}</span>` : ''}
        ${subtasksTotal ? `<span class="todo-tag">${subtasksDone}/${subtasksTotal} subtasks</span>` : ''}
      </div>
      ${subtasksHTML}
      <div class="subtask-add" style="margin-top:0.4rem;margin-left:1.6rem">
        <input id="sub-input-${t.id}" type="text" placeholder="Add subtask‚Ä¶" onkeydown="if(event.key==='Enter')addSubtask(${t.id})" />
        <button onclick="addSubtask(${t.id})">+</button>
      </div>
    </div>`;
}

async function renderTodos() {
  const todos = await getTodos();
  const todayKey = dateKey(currentDate);

  // Daily = added today OR type daily and not backlog
  const daily   = todos.filter(t => t.type === 'daily' && t.dateAdded === todayKey);
  const backlog  = todos.filter(t => t.type === 'backlog');

  const filterFn = (f) => (t) => f === 'all' || t.priority === f;

  const dailyEl = document.getElementById('todo-daily-list');
  const backlogEl = document.getElementById('todo-backlog-list');

  const dailyFiltered = daily.filter(filterFn(todoFilters.daily));
  const backlogFiltered = backlog.filter(filterFn(todoFilters.backlog));

  if (dailyEl) {
    dailyEl.innerHTML = dailyFiltered.length
      ? dailyFiltered.map(buildTodoItem).join('')
      : '<div class="empty-state">No tasks for today yet</div>';
  }
  if (backlogEl) {
    backlogEl.innerHTML = backlogFiltered.length
      ? backlogFiltered.map(buildTodoItem).join('')
      : '<div class="empty-state">Backlog is clear!</div>';
  }

  // Stats
  const todayDone  = daily.filter(t=>t.done).length;
  const todayTotal = daily.length;
  const overdueCnt = todos.filter(t=>!t.done && isOverdue(t.due)).length;
  const pct = todayTotal ? Math.round(todayDone/todayTotal*100) : 0;

  const s = (id, val) => { const el=document.getElementById(id); if(el) el.textContent=val; };
  s('stat-today-done', todayDone);
  s('stat-today-total', todayTotal);
  s('stat-backlog', backlog.length);
  s('stat-overdue', overdueCnt);
  s('todo-progress-label', pct + '% complete');
  const bar = document.getElementById('todo-progress-bar');
  if (bar) bar.style.width = pct + '%';
}


// ‚îÄ‚îÄ‚îÄ RECIPE BOOK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let rbIngredients = [];
let rbSteps = [];

// getRbRecipes() and saveRbRecipesToFS() are defined above in Firebase section

function openRecipeBookForm(id) {
  if (id) editRbRecipe(id); else clearRbForm();
  document.getElementById('rb-modal-overlay').classList.add('open');
}
function closeRecipeBookForm(e) {
  if (e && e.target !== document.getElementById('rb-modal-overlay')) return;
  document.getElementById('rb-modal-overlay').classList.remove('open');
}
function closeRbDetail(e) {
  if (e && e.target !== document.getElementById('rb-detail-overlay')) return;
  document.getElementById('rb-detail-overlay').classList.remove('open');
}

function addRbIng() {
  const name = document.getElementById('rb-ing-name').value.trim();
  const qty  = document.getElementById('rb-ing-qty').value.trim();
  const note = document.getElementById('rb-ing-note').value.trim();
  if (!name) return;
  rbIngredients.push({ id: Date.now(), name, qty, note });
  ['rb-ing-name','rb-ing-qty','rb-ing-note'].forEach(id => document.getElementById(id).value='');
  renderRbIngList();
}
function removeRbIng(id) {
  rbIngredients = rbIngredients.filter(i => i.id !== id);
  renderRbIngList();
}
function renderRbIngList() {
  const el = document.getElementById('rb-ing-list'); if (!el) return;
  if (!rbIngredients.length) { el.innerHTML = '<div style="font-size:0.7rem;color:var(--ink3);padding:0.3rem 0">No ingredients yet</div>'; return; }
  el.innerHTML = rbIngredients.map((i,idx) => `
    <div class="ing-item-build">
      <span style="color:var(--ink3);min-width:18px;font-size:0.62rem">${idx+1}.</span>
      <span><strong>${i.qty ? i.qty+' ' : ''}${i.name}</strong>${i.note ? ' <span style="color:var(--ink3)">‚Äî '+i.note+'</span>' : ''}</span>
      <button class="ing-del" onclick="removeRbIng(${i.id})">‚úï</button>
    </div>`).join('');
}

function addRbStep() {
  const text = document.getElementById('rb-step-text').value.trim();
  if (!text) return;
  rbSteps.push({ id: Date.now(), text });
  document.getElementById('rb-step-text').value = '';
  renderRbStepsList();
}
function removeRbStep(id) {
  rbSteps = rbSteps.filter(s => s.id !== id);
  renderRbStepsList();
}
function renderRbStepsList() {
  const el = document.getElementById('rb-steps-list'); if (!el) return;
  if (!rbSteps.length) { el.innerHTML = '<div style="font-size:0.7rem;color:var(--ink3);padding:0.3rem 0">No steps yet</div>'; return; }
  el.innerHTML = rbSteps.map((s,i) => `
    <div class="ing-item-build">
      <span style="background:var(--food);color:white;border-radius:50%;min-width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:700;flex-shrink:0">${i+1}</span>
      <span>${s.text}</span>
      <button class="ing-del" onclick="removeRbStep(${s.id})">‚úï</button>
    </div>`).join('');
}

async function saveRbRecipe() {
  const name = document.getElementById('rb-name').value.trim();
  if (!name) { alert('Please enter a recipe name'); return; }
  const editId = document.getElementById('rb-edit-id').value;
  const recipe = {
    id: editId ? parseInt(editId) : Date.now(),
    name,
    category:  document.getElementById('rb-category').value.trim(),
    cuisine:   document.getElementById('rb-cuisine').value.trim(),
    servings:  parseInt(document.getElementById('rb-servings').value) || 1,
    preptime:  parseInt(document.getElementById('rb-preptime').value) || 0,
    cooktime:  parseInt(document.getElementById('rb-cooktime').value) || 0,
    cal:     parseFloat(document.getElementById('rb-cal').value)     || 0,
    protein: parseFloat(document.getElementById('rb-protein').value) || 0,
    carbs:   parseFloat(document.getElementById('rb-carbs').value)   || 0,
    fat:     parseFloat(document.getElementById('rb-fat').value)     || 0,
    fiber:   parseFloat(document.getElementById('rb-fiber').value)   || 0,
    sugar:   parseFloat(document.getElementById('rb-sugar').value)   || 0,
    sodium:  parseFloat(document.getElementById('rb-sodium').value)  || 0,
    notes:   document.getElementById('rb-notes').value.trim(),
    ingredients: [...rbIngredients],
    steps:       [...rbSteps],
    createdAt: new Date().toISOString()
  };
  showSync('saving‚Ä¶', '#e8b83a');
  try {
    if (editId) {
      const existing = (await getRbRecipes()).find(r => r.id === parseInt(editId));
      if (existing && existing.firestoreId) {
        const { firestoreId, ...data } = recipe;
        await updateDoc(doc(db, "users", USER, "rbRecipes", existing.firestoreId), data);
      } else {
        await addDoc(collection(db, "users", USER, "rbRecipes"), recipe);
      }
    } else {
      await addDoc(collection(db, "users", USER, "rbRecipes"), recipe);
    }
    _rbRecipesCache = null;
    showSync('‚úì saved');
  } catch(e) {
    console.error('saveRbRecipe error', e);
    showSync('‚ö† save failed', '#e8623a');
    return;
  }
  clearRbForm();
  document.getElementById('rb-modal-overlay').classList.remove('open');
  renderRecipeBook();
}

function clearRbForm() {
  ['rb-edit-id','rb-name','rb-category','rb-cuisine','rb-preptime','rb-cooktime',
   'rb-cal','rb-protein','rb-carbs','rb-fat','rb-fiber','rb-sugar','rb-sodium','rb-notes',
   'rb-ing-name','rb-ing-qty','rb-ing-note','rb-step-text'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  document.getElementById('rb-servings').value = '1';
  document.getElementById('rb-form-title').textContent = 'New Recipe';
  rbIngredients = []; rbSteps = [];
  renderRbIngList(); renderRbStepsList();
}

async function editRbRecipe(id) {
  const r = (await getRbRecipes()).find(r => r.id === id); if (!r) return;
  document.getElementById('rb-edit-id').value  = r.id;
  document.getElementById('rb-name').value     = r.name;
  document.getElementById('rb-category').value = r.category  || '';
  document.getElementById('rb-cuisine').value  = r.cuisine   || '';
  document.getElementById('rb-servings').value = r.servings  || 1;
  document.getElementById('rb-preptime').value = r.preptime  || '';
  document.getElementById('rb-cooktime').value = r.cooktime  || '';
  document.getElementById('rb-cal').value      = r.cal       || '';
  document.getElementById('rb-protein').value  = r.protein   || '';
  document.getElementById('rb-carbs').value    = r.carbs     || '';
  document.getElementById('rb-fat').value      = r.fat       || '';
  document.getElementById('rb-fiber').value    = r.fiber     || '';
  document.getElementById('rb-sugar').value    = r.sugar     || '';
  document.getElementById('rb-sodium').value   = r.sodium    || '';
  document.getElementById('rb-notes').value    = r.notes     || '';
  document.getElementById('rb-form-title').textContent = 'Edit Recipe';
  rbIngredients = [...(r.ingredients || [])];
  rbSteps       = [...(r.steps || [])];
  renderRbIngList(); renderRbStepsList();
}

async function deleteRbRecipe(id) {
  if (!confirm('Delete this recipe?')) return;
  const r = (await getRbRecipes()).find(r => r.id === id);
  if (r && r.firestoreId) {
    showSync('saving‚Ä¶', '#e8b83a');
    try {
      await deleteDoc(doc(db, "users", USER, "rbRecipes", r.firestoreId));
      _rbRecipesCache = null;
      showSync('‚úì deleted');
    } catch(e) { showSync('‚ö† failed', '#e8623a'); return; }
  }
  renderRecipeBook();
}

async function viewRbRecipe(id) {
  const r = (await getRbRecipes()).find(r => r.id === id); if (!r) return;
  const totalTime = (r.preptime||0) + (r.cooktime||0);
  const nutCells = [
    ['Calories', r.cal, 'kcal'],
    ['Protein',  r.protein, 'g'],
    ['Carbs',    r.carbs,   'g'],
    ['Fat',      r.fat,     'g'],
    ['Fiber',    r.fiber,   'g'],
    ['Sugar',    r.sugar,   'g'],
    ['Sodium',   r.sodium,  'mg'],
  ].map(([lbl,val,unit]) => `
    <div class="rb-nut-full-cell">
      <div class="val">${val||0}<span style="font-size:0.6rem;font-family:'DM Mono',monospace"> ${unit}</span></div>
      <div class="lbl">${lbl}</div>
    </div>`).join('');

  const ingsHTML = (r.ingredients||[]).length
    ? `<table class="rb-ing-table">${(r.ingredients).map(i=>`<tr><td>${i.qty||'‚Äî'}</td><td>${i.name}${i.note?' <span style="color:var(--ink3);font-size:0.65rem">'+i.note+'</span>':''}</td></tr>`).join('')}</table>`
    : '<div style="font-size:0.72rem;color:var(--ink3)">No ingredients listed</div>';

  const stepsHTML = (r.steps||[]).length
    ? (r.steps).map((s,i) => `<div class="rb-step-item-view"><div class="rb-step-num-view">${i+1}</div><div class="rb-step-text-view">${s.text}</div></div>`).join('')
    : '<div style="font-size:0.72rem;color:var(--ink3)">No steps listed</div>';

  document.getElementById('rb-detail-modal').innerHTML = `
    <div class="rb-detail-header">
      <button class="rb-detail-close" onclick="document.getElementById('rb-detail-overlay').classList.remove('open')">‚úï</button>
      <h2>${r.name}</h2>
      <div class="rb-sub">
        ${r.category ? r.category : ''}${r.cuisine ? ' ¬∑ '+r.cuisine : ''}
        &nbsp;¬∑&nbsp; ${r.servings} serving${r.servings>1?'s':''}
        ${totalTime ? ' ¬∑ ‚è± '+ totalTime +' min total' : ''}
        ${r.preptime ? ' (prep '+r.preptime+'min' : ''}${r.cooktime ? ' ¬∑ cook '+r.cooktime+'min)' : (r.preptime ? ')' : '')}
      </div>
    </div>
    <div class="rb-detail-body">
      <div class="rb-detail-section-title">Nutrition per serving</div>
      <div class="rb-nut-full">${nutCells}</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-top:0.5rem">
        <div>
          <div class="rb-detail-section-title">Ingredients</div>
          ${ingsHTML}
        </div>
        <div>
          <div class="rb-detail-section-title">Steps</div>
          ${stepsHTML}
        </div>
      </div>

      ${r.notes ? `<div class="rb-detail-section-title">Notes</div><div class="rb-notes-box">${r.notes}</div>` : ''}

      <div style="display:flex;gap:0.5rem;margin-top:1.2rem;justify-content:flex-end">
        <button class="btn-add" onclick="openRecipeBookForm(${r.id});document.getElementById('rb-detail-overlay').classList.remove('open')" style="background:var(--ink2)">‚úèÔ∏è Edit</button>
      </div>
    </div>`;
  document.getElementById('rb-detail-overlay').classList.add('open');
}

async function renderRecipeBook() {
  const el = document.getElementById('rb-list'); if (!el) return;
  const q   = (document.getElementById('rb-search')||{}).value || '';
  const cat = (document.getElementById('rb-filter-cat')||{}).value || '';
  let recipes = await getRbRecipes();

  // Populate category filter
  const catEl = document.getElementById('rb-filter-cat');
  if (catEl) {
    const cats = [...new Set(recipes.map(r=>r.category).filter(Boolean))];
    const curVal = catEl.value;
    catEl.innerHTML = '<option value="">All categories</option>' +
      cats.map(c=>`<option value="${c}" ${curVal===c?'selected':''}>${c}</option>`).join('');
  }

  if (q)   recipes = recipes.filter(r => r.name.toLowerCase().includes(q.toLowerCase()) || (r.category||'').toLowerCase().includes(q.toLowerCase()) || (r.cuisine||'').toLowerCase().includes(q.toLowerCase()));
  if (cat) recipes = recipes.filter(r => r.category === cat);

  if (!recipes.length) {
    el.innerHTML = '<div class="empty-state" style="padding:3rem">No recipes yet.<br>Click <strong>+ New Recipe</strong> to add your first one!</div>';
    return;
  }

  el.innerHTML = '<div class="rb-grid">' + recipes.map((r,i) => `
    <div class="rb-card" style="animation-delay:${i*0.04}s">
      <div class="rb-card-header">
        <div class="rb-card-name">${r.name}</div>
        <div class="rb-card-sub">
          ${r.category||''}${r.cuisine?' ¬∑ '+r.cuisine:''}
          &nbsp;¬∑&nbsp; ${r.servings} serving${r.servings>1?'s':''}
          ${(r.preptime||r.cooktime) ? ' ¬∑ ‚è± '+((r.preptime||0)+(r.cooktime||0))+'min' : ''}
        </div>
      </div>
      <div class="rb-card-body">
        <div class="rb-nutrition-row">
          <div class="rb-nut-cell"><div class="rb-nut-val">${r.cal}</div><div class="rb-nut-lbl">kcal</div></div>
          <div class="rb-nut-cell"><div class="rb-nut-val">${r.protein}g</div><div class="rb-nut-lbl">protein</div></div>
          <div class="rb-nut-cell"><div class="rb-nut-val">${r.carbs}g</div><div class="rb-nut-lbl">carbs</div></div>
          <div class="rb-nut-cell"><div class="rb-nut-val">${r.fat}g</div><div class="rb-nut-lbl">fat</div></div>
        </div>
        ${r.ingredients&&r.ingredients.length ? `<div style="font-size:0.62rem;color:var(--ink3)">${r.ingredients.length} ingredient${r.ingredients.length>1?'s':''} ¬∑ ${r.steps&&r.steps.length?r.steps.length+' step'+(r.steps.length>1?'s':''):'no steps'}</div>` : ''}
      </div>
      <div class="rb-card-footer">
        <button class="rb-view-btn" onclick="viewRbRecipe(${r.id})">üëÅ View</button>
        <button onclick="openRecipeBookForm(${r.id})">‚úèÔ∏è Edit</button>
        <button onclick="deleteRbRecipe(${r.id})">‚úï</button>
      </div>
    </div>`).join('') + '</div>';
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderAll() {
  renderDashboard();
  renderFood();
  renderExpenses();
  renderSport();
  renderSleep();
  renderHabits();
  renderNotes();
  renderWeekly();
  renderLibrary();
  renderTodos();
  renderRecipeList();
  renderRecipeBook();
}

updateDateDisplay();
renderAll();

// ‚îÄ‚îÄ‚îÄ EXPOSE TO GLOBAL SCOPE (required for inline onclick handlers with type="module") ‚îÄ‚îÄ
Object.assign(window, {
  googleSignIn, googleSignOut,
  changeDay, switchTab, switchFoodTab,
  addFood, deleteFood,
  addExpense, deleteExpense,
  addSport, deleteSport,
  saveSleep,
  addHabit, toggleHabit,
  saveNotes,
  saveToLibrary, deleteFoodFromLibrary, fillFromLibrary, filterLibrary,
  addIngredient, removeIngredient, addStep, removeStep,
  saveRecipe, clearRecipeForm, editRecipe, deleteRecipe, logRecipeAsFood,
  setMealView, setMealCat, openMealForm, closeMealForm, toggleRecipeDetail,
  togglePlanSelect, addPlanMeal, removePlanMeal,
  addRbIng, removeRbIng, addRbStep, removeRbStep,
  saveRbRecipe, clearRbForm, editRbRecipe, deleteRbRecipe, viewRbRecipe,
  openRecipeBookForm, closeRecipeBookForm, closeRbDetail,
  addTodo, toggleTodo, deleteTodo, moveTodo,
  addSubtask, toggleSubtask, deleteSubtask, setFilter,
  renderRecipeList, renderRecipeBook, renderAll
});
</script>
</div><!-- /app-wrapper -->
</body>
</html>
